/* ═══════════════════════════════════════════════════════
   CODE ROUTE PRO - JAVASCRIPT APPLICATION
   ═══════════════════════════════════════════════════════ */

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// QUESTION DATABASE - French Driving Test
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// Database generation helper
const generateQuestionsDB = () => {
  const sections = [
    {
      category: "Signalisation",
      count: 50,
      templates: [
        { type: "panneau", difficulty: 1 },
        { type: "feux", difficulty: 1 },
        { type: "marquage", difficulty: 2 },
        { type: "priorite", difficulty: 2 },
        { type: "interdiction", difficulty: 1 },
      ]
    },
    {
      category: "Priorités",
      count: 40,
      templates: [
        { type: "intersection", difficulty: 2 },
        { type: "pieton", difficulty: 2 },
        { type: "rondpoint", difficulty: 2 },
        { type: "urgence", difficulty: 3 },
      ]
    },
    {
      category: "Vitesse",
      count: 35,
      templates: [
        { type: "limitation", difficulty: 1 },
        { type: "distance", difficulty: 2 },
        { type: "meteo", difficulty: 2 },
        { type: "jeune", difficulty: 2 },
      ]
    },
    {
      category: "Alcool & Drogues",
      count: 30,
      templates: [
        { type: "taux", difficulty: 1 },
        { type: "elimination", difficulty: 2 },
        { type: "depistage", difficulty: 3 },
        { type: "sanctions", difficulty: 2 },
      ]
    },
    {
      category: "Sécurité",
      count: 40,
      templates: [
        { type: "ceinture", difficulty: 1 },
        { type: "enfant", difficulty: 2 },
        { type: "equipement", difficulty: 2 },
        { type: "panne", difficulty: 2 },
      ]
    },
    {
      category: "Conducteur",
      count: 30,
      templates: [
        { type: "vigilance", difficulty: 2 },
        { type: "telephone", difficulty: 1 },
        { type: "fatigue", difficulty: 2 },
        { type: "anglesMorts", difficulty: 2 },
      ]
    },
    {
      category: "Route",
      count: 35,
      templates: [
        { type: "conditions", difficulty: 2 },
        { type: "autoroute", difficulty: 2 },
        { type: "tunnel", difficulty: 2 },
        { type: "aquaplaning", difficulty: 3 },
      ]
    },
    {
      category: "Mécanique",
      count: 30,
      templates: [
        { type: "entretien", difficulty: 2 },
        { type: "pneus", difficulty: 2 },
        { type: "freins", difficulty: 2 },
        { type: "voyants", difficulty: 1 },
      ]
    },
    {
      category: "Premiers Secours",
      count: 25,
      templates: [
        { type: "urgence", difficulty: 1 },
        { type: "PLS", difficulty: 2 },
        { type: "hemorragie", difficulty: 3 },
        { type: "accident", difficulty: 2 },
      ]
    },
    {
      category: "Éco-conduite",
      count: 30,
      templates: [
        { type: "consommation", difficulty: 2 },
        { type: "anticipation", difficulty: 2 },
        { type: "climatisation", difficulty: 2 },
        { type: "vitesse", difficulty: 2 },
      ]
    }
  ];

  const questionBank = {
    "Signalisation": {
      panneau: [
        { q: "Que signifie ce panneau ?", img: "assets/panneau_stop.svg", opts: ["Arrêt obligatoire", "Ralentir", "Céder le passage", "Intersection"], correct: 0, exp: "Le panneau STOP impose un arrêt complet avant la ligne.", tip: "STOP = Arrêt obligatoire, même si la voie est libre.", mistake: "Ralentir sans s'arrêter complètement." },
        { q: "Ce panneau indique :", img: "assets/panneau_route_prioritaire.svg", opts: ["Route prioritaire", "Attention danger", "Parking autorisé", "Zone résidentielle"], correct: 0, exp: "Le losange jaune signale une route prioritaire.", tip: "Vous êtes prioritaire sur les intersections suivantes.", mistake: "Confondre avec un panneau de danger." },
        { q: "Quelle est la signification de ce panneau ?", img: "assets/panneau_cedez_le_passage.svg", opts: ["Cédez le passage", "Stop", "Priorité à droite", "Sens interdit"], correct: 0, exp: "Triangle inversé = céder le passage aux véhicules prioritaires.", tip: "Ralentir et céder si nécessaire, mais pas d'arrêt obligatoire.", mistake: "S'arrêter systématiquement comme au STOP." },
        { q: "Ce panneau signifie :", img: "assets/panneau_stationnement_interdit.svg", opts: ["Stationnement interdit", "Arrêt interdit", "Sens interdit", "Zone bleue"], correct: 0, exp: "Panneau d'interdiction de stationner (une barre rouge).", tip: "Une barre = stationnement interdit. Deux barres = arrêt interdit.", mistake: "Confondre avec l'arrêt interdit (deux barres)." },
        { q: "Panneau triangulaire pointe en haut :", opts: ["Une obligation", "Un danger", "Une interdiction", "Une indication"], correct: 1, exp: "Triangle pointe en haut = signaux de danger (virage, école, etc.).", tip: "Forme triangulaire rouge = attention danger à venir.", mistake: "Confondre avec les panneaux d'obligation (ronds bleus)." },
        { q: "Panneau rond fond bleu signifie :", opts: ["Interdiction", "Obligation", "Indication", "Danger"], correct: 1, exp: "Panneau bleu rond = obligation à respecter.", tip: "Bleu = obligation, Rouge = interdiction.", mistake: "Confondre obligation et interdiction." },
        { q: "Panneau carré fond bleu indique :", opts: ["Indication", "Interdiction", "Obligation", "Danger"], correct: 0, exp: "Panneau bleu carré/rectangulaire = indication (info).", tip: "Carré bleu = information utile.", mistake: "Penser que c'est une obligation." },
        { q: "Sens interdit se reconnaît par :", opts: ["Cercle rouge barre blanche", "Triangle rouge", "Carré bleu", "Losange jaune"], correct: 0, exp: "Cercle rouge avec barre blanche horizontale = sens interdit.", tip: "Ne jamais engager votre véhicule.", mistake: "Entrer en sens interdit." },
        { q: "Limitation de vitesse : forme du panneau ?", opts: ["Cercle rouge", "Triangle rouge", "Carré bleu", "Losange jaune"], correct: 0, exp: "Cercle rouge avec chiffre = vitesse maximale.", tip: "Toujours respecter la limitation.", mistake: "Dépasser de quelques km/h." },
        { q: "Zone 30 se termine par quel panneau ?", opts: ["Cercle barré", "Triangle", "Carré", "Losange"], correct: 0, exp: "Cercle barré = fin de limitation/zone.", tip: "Barré = fin de prescription.", mistake: "Continuer à 30 après la fin." },
      ],
      feux: [
        { q: "Feu orange signifie :", opts: ["Accélérer", "S'arrêter sauf si dangereux", "Continuer", "Klaxonner"], correct: 1, exp: "Feu orange = arrêt obligatoire sauf si impossible sans danger.", tip: "Orange = stop, sauf si vous êtes trop près pour freiner.", mistake: "Accélérer pour 'griller' le feu orange." },
        { q: "Feu rouge : que faire ?", opts: ["Arrêt obligatoire", "Ralentir", "Continuer prudemment", "Klaxonner"], correct: 0, exp: "Feu rouge = arrêt complet obligatoire.", tip: "Ne jamais franchir un feu rouge.", mistake: "Griller le feu rouge." },
        { q: "Feu vert clignotant signifie :", opts: ["Passage autorisé", "Va passer orange", "Ralentir", "S'arrêter"], correct: 1, exp: "Feu vert clignotant annonce le passage à l'orange.", tip: "Préparez-vous à vous arrêter.", mistake: "Accélérer." },
        { q: "Feu rouge + flèche verte droite :", opts: ["Tourner à droite autorisé", "Interdit", "Tout droit seulement", "Attendre"], correct: 0, exp: "Flèche verte = direction autorisée malgré feu rouge.", tip: "Céder le passage aux autres usagers.", mistake: "Ne pas céder le passage." },
        { q: "Feu jaune clignotant indique :", opts: ["Danger, ralentir", "Arrêt", "Accélérer", "Rien"], correct: 0, exp: "Jaune clignotant = prudence, danger temporaire.", tip: "Adapter vitesse et vigilance.", mistake: "Ignorer le signal." },
      ],
      marquage: [
        { q: "Ligne blanche continue : peut-on la franchir ?", opts: ["Non", "Oui si prudent", "Oui pour dépasser", "Oui en ville"], correct: 0, exp: "Ligne continue = interdiction de franchir.", tip: "Continue = ne pas franchir.", mistake: "Franchir pour dépasser." },
        { q: "Ligne discontinue : franchissement ?", opts: ["Autorisé si prudent", "Interdit", "Seulement en ville", "Jamais"], correct: 0, exp: "Ligne discontinue = franchissement autorisé si sécurité.", tip: "Vérifier avant de franchir.", mistake: "Franchir sans vérifier." },
        { q: "Double ligne (continue + discontinue) :", opts: ["Franchir du côté discontinu", "Jamais franchir", "Toujours franchir", "Franchir partout"], correct: 0, exp: "Franchir uniquement du côté discontinu.", tip: "Côté discontinu = franchissement autorisé.", mistake: "Franchir côté continu." },
        { q: "Ligne jaune au sol signifie :", opts: ["Stationnement interdit", "Autorisé", "Zone payante", "Rien"], correct: 0, exp: "Ligne jaune = arrêt et stationnement interdits.", tip: "Jaune = ne pas stationner.", mistake: "Stationner sur ligne jaune." },
        { q: "Passage piéton marquage :", opts: ["Bandes blanches", "Ligne jaune", "Ligne verte", "Aucun"], correct: 0, exp: "Bandes blanches = passage piéton.", tip: "Céder le passage obligatoire.", mistake: "Ne pas céder au piéton." },
      ],
      priorite: [
        { q: "Losange jaune indique :", opts: ["Route prioritaire", "Danger", "Stationnement", "Zone 30"], correct: 0, exp: "Losange jaune = route prioritaire.", tip: "Vous êtes prioritaire.", mistake: "Ne pas rester vigilant." },
        { q: "Triangle inversé signifie :", opts: ["Céder le passage", "Stop", "Priorité", "Danger"], correct: 0, exp: "Triangle inversé = céder le passage.", tip: "Ralentir et céder si besoin.", mistake: "Ne pas céder." },
        { q: "Panneau STOP : action obligatoire ?", opts: ["Arrêt complet", "Ralentir", "Céder", "Klaxonner"], correct: 0, exp: "STOP = arrêt complet obligatoire.", tip: "Toujours marquer l'arrêt.", mistake: "Ralentir seulement." },
        { q: "À un rond-point, vous devez :", img: "assets/panneau_rond_point.svg", opts: ["Céder aux véhicules engagés", "Être prioritaire", "Klaxonner", "Accélérer"], correct: 0, exp: "Priorité aux véhicules circulant dans le rond-point.", tip: "Toujours céder le passage à gauche.", mistake: "S'engager sans vérifier." },
        { q: "Fin de priorité : panneau ?", opts: ["Losange barré", "Triangle", "Cercle", "Carré"], correct: 0, exp: "Losange jaune barré = fin de route prioritaire.", tip: "Prudence après ce panneau.", mistake: "Rester prioritaire." },
      ],
      interdiction: [
        { q: "Cette limitation indique :", img: "assets/panneau_limitation_50.svg", opts: ["50 km/h maximum", "50 km/h minimum", "50 mètres", "Poids 50 tonnes"], correct: 0, exp: "Cercle rouge = interdiction. Ici, vitesse maximale 50 km/h.", tip: "En agglomération, 50 km/h est la règle générale.", mistake: "Dépasser légèrement." },
        { q: "Interdiction de tourner à gauche :", opts: ["Cercle rouge flèche barrée", "Triangle", "Carré", "Losange"], correct: 0, exp: "Cercle rouge avec flèche barrée = interdiction de tourner.", tip: "Respecter l'interdiction.", mistake: "Tourner quand même." },
        { q: "Dépassement interdit : panneau ?", opts: ["Deux voitures cercle rouge", "Triangle", "Carré", "Losange"], correct: 0, exp: "Deux véhicules dans cercle rouge = dépassement interdit.", tip: "Ne jamais dépasser.", mistake: "Dépasser quand même." },
        { q: "Hauteur limitée : type de panneau ?", opts: ["Cercle rouge avec hauteur", "Triangle", "Carré", "Losange"], correct: 0, exp: "Cercle rouge = interdiction selon hauteur.", tip: "Vérifier hauteur véhicule.", mistake: "Passer sans vérifier." },
        { q: "Poids limité : signalisation ?", opts: ["Cercle rouge avec tonnage", "Triangle", "Carré", "Losange"], correct: 0, exp: "Cercle rouge = interdiction selon poids.", tip: "Respecter limitation.", mistake: "Ignorer si léger dépassement." },
      ]
    },
    "Priorités": {
      intersection: [
        { q: "À une intersection sans panneau, qui est prioritaire ?", opts: ["Celui qui vient de droite", "De gauche", "Le plus gros", "Qui klaxonne"], correct: 0, exp: "Règle de base : priorité à droite en l'absence de signalisation.", tip: "Pas de panneau ? Priorité à droite !", mistake: "Penser être prioritaire sur grande route." },
        { q: "Vous êtes sur route prioritaire. Véhicule de droite ne cède pas :", opts: ["Ralentir et vérifier", "Passer, prioritaire", "Klaxonner", "Accélérer"], correct: 0, exp: "Priorité ne dispense pas de prudence.", tip: "Priorité ≠ raison dans accident.", mistake: "Foncer car prioritaire." },
        { q: "Intersection en T : qui est prioritaire ?", opts: ["Route principale", "Route perpendiculaire", "À droite toujours", "Plus rapide"], correct: 0, exp: "Route principale prioritaire sauf signalisation contraire.", tip: "Vérifier panneaux.", mistake: "Appliquer priorité droite." },
        { q: "Deux véhicules face à face tournent :", opts: ["Priorité à droite", "Celui qui va tout droit", "À gauche", "Plus rapide"], correct: 1, exp: "Véhicule allant tout droit prioritaire sur celui qui tourne.", tip: "Tout droit > tourner.", mistake: "Tourner sans céder." },
        { q: "Vous tournez à gauche, véhicule en face :", opts: ["Céder le passage", "Prioritaire", "Klaxonner", "Accélérer"], correct: 0, exp: "Tourner à gauche = céder passage véhicules en face.", tip: "Toujours céder en tournant à gauche.", mistake: "Ne pas céder." },
      ],
      pieton: [
        { q: "Piéton sur passage vs véhicule prioritaire :", opts: ["Piéton toujours", "Véhicule prioritaire", "Dépend situation", "Plus rapide"], correct: 0, exp: "Piéton engagé sur passage = TOUJOURS prioritaire.", tip: "Piéton > Tout.", mistake: "Penser ambulance prioritaire." },
        { q: "Piéton s'engage sur passage :", opts: ["Arrêt obligatoire", "Ralentir", "Klaxonner", "Continuer"], correct: 0, exp: "Piéton engagé = arrêt immédiat obligatoire.", tip: "Toujours céder.", mistake: "Passer devant." },
        { q: "Passage piéton sans feu : priorité ?", opts: ["Piéton", "Voiture", "Dépend", "À droite"], correct: 0, exp: "Piéton toujours prioritaire sur passage.", tip: "Céder systématiquement.", mistake: "Ne pas céder." },
        { q: "Piéton traverse hors passage :", opts: ["Prudence, ralentir", "Prioritaire", "Klaxonner fort", "Accélérer"], correct: 0, exp: "Piéton hors passage = prudence mais pas priorité légale.", tip: "Éviter accident quand même.", mistake: "Ignorer complètement." },
        { q: "Zone de rencontre : vitesse et piétons ?", opts: ["20 km/h, piétons prioritaires", "50 km/h", "30 km/h", "Aucune règle"], correct: 0, exp: "Zone de rencontre = 20 km/h max, piétons prioritaires.", tip: "Prudence maximale.", mistake: "Rouler vite." },
      ],
      rondpoint: [
        { q: "Rond-point : priorité à qui ?", opts: ["Véhicules dans rond-point", "Entrants", "À droite", "Plus rapide"], correct: 0, exp: "Priorité aux véhicules déjà dans le rond-point.", tip: "Céder à gauche.", mistake: "S'engager sans regarder." },
        { q: "Sortir rond-point : clignotant ?", opts: ["Oui à droite", "Non", "À gauche", "Les deux"], correct: 0, exp: "Clignotant droit pour indiquer sortie.", tip: "Signal avant de sortir.", mistake: "Ne pas signaler." },
        { q: "Rond-point à 2 voies : quelle voie ?", opts: ["Intérieure si plus d'1/2 tour", "Extérieure toujours", "Au choix", "Rapide"], correct: 0, exp: "Voie intérieure pour dépasser demi-tour.", tip: "Extérieur pour sorties proches.", mistake: "Rester intérieur pour sortie proche." },
        { q: "Rond-point sans panneau :", opts: ["Priorité à droite", "À gauche", "Entrant prioritaire", "Au choix"], correct: 0, exp: "Sans panneau = priorité à droite classique.", tip: "Rare mais existe.", mistake: "Appliquer règle moderne." },
      ],
      urgence: [
        { q: "Véhicule prioritaire gyrophare/sirène :", opts: ["Faciliter passage", "Garder trajectoire", "Accélérer", "Freiner"], correct: 0, exp: "Faciliter passage véhicule prioritaire obligatoire.", tip: "Se ranger, céder passage.", mistake: "Continuer normalement." },
        { q: "Ambulance derrière vous :", opts: ["Se ranger à droite", "Accélérer", "S'arrêter milieu", "Ignorer"], correct: 0, exp: "Se ranger à droite pour laisser passer.", tip: "Rapidement mais prudemment.", mistake: "S'arrêter n'importe où." },
        { q: "Convoi exceptionnel : priorité ?", opts: ["Oui, ne pas couper", "Non", "Dépend", "Si rapide"], correct: 0, exp: "Convoi exceptionnel = ne pas s'insérer.", tip: "Attendre passage complet.", mistake: "Couper le convoi." },
      ]
    },
    "Vitesse": {
      limitation: [
        { q: "Vitesse max en agglomération véhicule léger ?", opts: ["50 km/h", "60 km/h", "70 km/h", "80 km/h"], correct: 0, exp: "50 km/h en ville, sauf indication contraire.", tip: "Panneau agglomération = 50 km/h auto.", mistake: "Rouler à 60 car tout le monde le fait." },
        { q: "Autoroute temps sec : vitesse max ?", opts: ["130 km/h", "110 km/h", "90 km/h", "150 km/h"], correct: 0, exp: "130 km/h maximum sur autoroute temps sec.", tip: "Respecter strictement.", mistake: "Dépasser." },
        { q: "Route à double sens hors agglomération :", opts: ["80 km/h", "90 km/h", "70 km/h", "110 km/h"], correct: 0, exp: "80 km/h sur routes bidirectionnelles depuis 2018.", tip: "Limitation générale.", mistake: "Rouler à 90." },
        { q: "Voie rapide (2×2 voies) : vitesse ?", opts: ["110 km/h", "130 km/h", "90 km/h", "100 km/h"], correct: 0, exp: "110 km/h max sur voie rapide.", tip: "Moins qu'autoroute.", mistake: "Confondre avec autoroute." },
        { q: "Zone 30 : vitesse maximale ?", opts: ["30 km/h", "40 km/h", "50 km/h", "20 km/h"], correct: 0, exp: "Zone 30 = 30 km/h maximum.", tip: "Zones résidentielles/écoles.", mistake: "Rouler plus vite." },
      ],
      distance: [
        { q: "Distance sécurité autoroute 130 km/h ?", opts: ["2 secondes", "1 seconde", "3 secondes", "5 secondes"], correct: 0, exp: "Règle des 2 secondes minimum.", tip: "Un crocodile, deux crocodiles.", mistake: "Coller véhicule devant." },
        { q: "Comment mesurer distance sécurité ?", opts: ["Repère fixe + 2 sec", "Mètres", "Longueurs voiture", "Au jugé"], correct: 0, exp: "Repère fixe, compter 2 sec avant passage.", tip: "Méthode fiable.", mistake: "Estimer en mètres." },
        { q: "Pluie : adapter distance ?", opts: ["Oui, doubler", "Non", "Réduire", "Inutile"], correct: 0, exp: "Pluie = doubler distance sécurité.", tip: "Adhérence réduite.", mistake: "Garder même distance." },
        { q: "Distance d'arrêt = ?", opts: ["Réaction + freinage", "Freinage seul", "Réaction seule", "Au hasard"], correct: 0, exp: "Distance arrêt = temps réaction + distance freinage.", tip: "Augmente avec vitesse.", mistake: "Oublier temps réaction." },
      ],
      meteo: [
        { q: "Autoroute par temps de pluie : vitesse max ?", opts: ["110 km/h", "130 km/h", "90 km/h", "50 km/h"], correct: 0, exp: "Pluie : -20 km/h sur autoroute (130 → 110).", tip: "Réduire vitesse pluie.", mistake: "Garder 130." },
        { q: "Brouillard visibilité < 50m : vitesse ?", opts: ["50 km/h", "90 km/h", "70 km/h", "30 km/h"], correct: 0, exp: "Brouillard épais (<50m) = 50 km/h max.", tip: "Feux brouillard obligatoires.", mistake: "Rouler à 90." },
        { q: "Neige/verglas : vitesse adaptée ?", opts: ["Oui, très réduite", "Non", "Un peu", "Inutile"], correct: 0, exp: "Neige/verglas = vitesse très réduite.", tip: "Adhérence quasi nulle.", mistake: "Garder vitesse normale." },
        { q: "Chaussée mouillée : freinage ?", opts: ["Allongé", "Identique", "Réduit", "Meilleur"], correct: 0, exp: "Chaussée mouillée = distance freinage allongée.", tip: "Anticiper davantage.", mistake: "Freiner comme sur sec." },
      ],
      jeune: [
        { q: "Jeune conducteur (< 3 ans) autoroute : vitesse ?", opts: ["110 km/h", "130 km/h", "100 km/h", "90 km/h"], correct: 0, exp: "Jeune conducteur : 110 km/h max autoroute.", tip: "Disque A obligatoire 3 ans.", mistake: "Rouler à 130 dès permis." },
        { q: "Jeune conducteur voie rapide : vitesse ?", opts: ["100 km/h", "110 km/h", "90 km/h", "80 km/h"], correct: 0, exp: "100 km/h max voie rapide jeune conducteur.", tip: "Limitations réduites.", mistake: "Rouler à 110." },
        { q: "Durée permis probatoire :", opts: ["3 ans (2 si AAC)", "2 ans", "1 an", "5 ans"], correct: 0, exp: "3 ans probatoire, 2 ans si conduite accompagnée.", tip: "Capital 6 points au départ.", mistake: "Penser 2 ans pour tous." },
        { q: "Alcool jeune conducteur : taux max ?", opts: ["0,2 g/L", "0,5 g/L", "0 g/L", "0,8 g/L"], correct: 0, exp: "0,2 g/L max pour jeune conducteur.", tip: "Quasi zéro alcool.", mistake: "Appliquer 0,5 g/L." },
      ]
    },
    "Alcool & Drogues": {
      taux: [
        { q: "Taux alcoolémie max (conducteur confirmé) ?", opts: ["0,5 g/L sang", "0,8 g/L", "0,2 g/L", "0 g/L"], correct: 0, exp: "0,5 g/L max confirmé, 0,2 g/L jeune.", tip: "≈ 2 verres standard.", mistake: "Penser 3-4 verres OK." },
        { q: "Taux alcool jeune conducteur ?", opts: ["0,2 g/L", "0,5 g/L", "0 g/L", "0,8 g/L"], correct: 0, exp: "0,2 g/L max jeune conducteur (quasi zéro).", tip: "Très restrictif.", mistake: "Appliquer 0,5." },
        { q: "Équivalence air expiré pour 0,5 g/L sang ?", opts: ["0,25 mg/L", "0,5 mg/L", "0,2 mg/L", "1 mg/L"], correct: 0, exp: "0,25 mg/L air = 0,5 g/L sang.", tip: "Éthylotest mesure air.", mistake: "Confondre unités." },
        { q: "Un verre standard contient combien d'alcool pur ?", opts: ["10g", "5g", "15g", "20g"], correct: 0, exp: "Verre standard = 10g alcool pur.", tip: "Vin, bière, whisky = équivalent.", mistake: "Penser bière < vin." },
      ],
      elimination: [
        { q: "Pour éliminer alcool, le plus efficace :", opts: ["Attendre (temps)", "Café", "Manger", "Douche froide"], correct: 0, exp: "Seul le temps élimine alcool.", tip: "0,15 g/L par heure.", mistake: "Croire café dégrise." },
        { q: "Vitesse élimination alcool :", opts: ["0,15 g/L/h", "0,5 g/L/h", "0,1 g/L/h", "1 g/L/h"], correct: 0, exp: "≈ 0,15 g/L éliminé par heure.", tip: "Donc 3h pour 0,5 g/L.", mistake: "Penser plus rapide." },
        { q: "Café accélère élimination alcool ?", opts: ["Non", "Oui", "Un peu", "Beaucoup"], correct: 0, exp: "Café ne change rien à élimination.", tip: "Seul temps compte.", mistake: "Boire café pour conduire." },
        { q: "Manger réduit alcoolémie ?", opts: ["Ralentit absorption", "Élimine alcool", "Aucun effet", "Augmente"], correct: 0, exp: "Manger ralentit absorption mais n'élimine pas.", tip: "Boire à jeun = pic rapide.", mistake: "Manger pour éliminer." },
      ],
      depistage: [
        { q: "Dépistage drogue positif (sans ivresse) :", opts: ["Retrait permis + prison", "Amende", "Avertissement", "Stage"], correct: 0, exp: "Conduite stupéfiants = délit : 2 ans prison, retrait.", tip: "Cannabis détectable longtemps.", mistake: "Penser ça va si fumé il y a 2 jours." },
        { q: "Refuser dépistage alcool/drogue :", opts: ["Même sanction que positif", "Amende légère", "Rien", "Stage seul"], correct: 0, exp: "Refus = même sanction que contrôle positif.", tip: "Obligatoire d'accepter.", mistake: "Refuser pour éviter." },
        { q: "Cannabis : durée détection dans sang ?", opts: ["Plusieurs jours/semaines", "1 heure", "1 jour", "1 semaine max"], correct: 0, exp: "Cannabis détectable plusieurs jours voire semaines.", tip: "Même sans effet ressenti.", mistake: "Penser éliminé rapidement." },
      ],
      sanctions: [
        { q: "Alcoolémie > 0,8 g/L : sanction ?", opts: ["Délit pénal", "Amende simple", "Avertissement", "Stage"], correct: 0, exp: "> 0,8 g/L = délit : tribunal, retrait, prison possible.", tip: "Très grave.", mistake: "Minimiser gravité." },
        { q: "Alcool + drogue : sanction ?", opts: ["Cumulées", "Une seule", "Réduite", "Aucune"], correct: 0, exp: "Alcool + drogue = sanctions cumulées.", tip: "Très sévère.", mistake: "Penser une seule sanction." },
        { q: "Conduite alcoolisée : retrait points ?", opts: ["6 points", "3 points", "1 point", "12 points"], correct: 0, exp: "Alcool = retrait 6 points.", tip: "Moitié du capital.", mistake: "Penser moins." },
      ]
    },
    "Sécurité": {
      ceinture: [
        { q: "Port ceinture obligatoire :", opts: ["Avant ET arrière", "Avant uniquement", "Autoroute seule", "Hors ville"], correct: 0, exp: "Ceinture obligatoire partout, avant ET arrière.", tip: "Ceinture = -50% mortalité.", mistake: "Détacher en ville." },
        { q: "Enfant < 10 ans ou < 135 cm :", opts: ["Siège adapté obligatoire", "Ceinture adulte", "Rien", "Au choix"], correct: 0, exp: "< 10 ans ou < 135 cm = siège obligatoire.", tip: "Homologué selon poids/taille.", mistake: "Ceinture adulte directement." },
        { q: "Femme enceinte : ceinture ?", opts: ["Oui, obligatoire", "Dispensée", "Au choix", "Si veut"], correct: 0, exp: "Femme enceinte = ceinture obligatoire.", tip: "Sangle sous le ventre.", mistake: "Penser dispensée." },
        { q: "Airbag sans ceinture :", opts: ["Dangereux", "Sûr", "Plus efficace", "Équivalent"], correct: 0, exp: "Airbag sans ceinture = danger (choc violent).", tip: "Airbag complète ceinture.", mistake: "Compter sur airbag seul." },
      ],
      enfant: [
        { q: "Enfant 8 ans : installation ?", opts: ["Siège/rehausseur", "Ceinture adulte", "Avant sans siège", "Debout arrière"], correct: 0, exp: "Jusqu'à 10 ans ou 135 cm : siège obligatoire.", tip: "Choisir homologué.", mistake: "Ceinture adulte à 8 ans." },
        { q: "Bébé < 1 an : position siège ?", opts: ["Dos route", "Face route", "Debout", "Couché"], correct: 0, exp: "Bébé dos à la route (nacelle/cosy).", tip: "Protège nuque.", mistake: "Face route trop tôt." },
        { q: "Enfant devant voiture :", opts: ["Possible si siège adapté", "Interdit toujours", "Libre", "Si > 5 ans"], correct: 0, exp: "Devant possible si siège adapté (airbag désactivé si dos route).", tip: "Préférer arrière.", mistake: "Mettre bébé dos route airbag actif." },
        { q: "Âge fin siège auto obligatoire :", opts: ["10 ans ou 135 cm", "12 ans", "8 ans", "5 ans"], correct: 0, exp: "Obligation jusqu'à 10 ans OU 135 cm.", tip: "Critère taille ET âge.", mistake: "Arrêter à 8 ans." },
      ],
      equipement: [
        { q: "Gilet haute visibilité : obligatoire ?", opts: ["Oui, dans véhicule", "Non", "Uniquement pro", "Au choix"], correct: 0, exp: "Gilet jaune obligatoire dans habitacle.", tip: "Porter si panne.", mistake: "Laisser dans coffre." },
        { q: "Triangle de présignalisation :", opts: ["Obligatoire", "Conseillé", "Interdit", "Inutile"], correct: 0, exp: "Triangle obligatoire dans véhicule.", tip: "Placer à 30m du véhicule.", mistake: "Ne pas en avoir." },
        { q: "Éthylotest : obligatoire ?", opts: ["Non (recommandé)", "Oui obligatoire", "Uniquement pro", "Interdit"], correct: 0, exp: "Plus obligatoire mais fortement recommandé.", tip: "Utile pour vérifier.", mistake: "Compter dessus sans fiabilité." },
        { q: "Roue de secours : obligatoire ?", opts: ["Non", "Oui", "Uniquement autoroute", "Si ancien"], correct: 0, exp: "Roue secours non obligatoire (kit réparation OK).", tip: "Vérifier présence.", mistake: "Penser obligatoire." },
      ],
      panne: [
        { q: "Crevaison autoroute : action ?", opts: ["Gilet + triangle, sécurité", "Réparer sur place", "Rester dedans", "Continuer"], correct: 0, exp: "Gilet, triangle 30m, sortir côté sécurité.", tip: "Derrière glissière, jamais dans voiture.", mistake: "Rester dans véhicule." },
        { q: "Panne sur autoroute : où s'arrêter ?", opts: ["Bande d'arrêt urgence", "Voie circulation", "Milieu route", "N'importe"], correct: 0, exp: "BAU obligatoire, allumer warnings.", tip: "Sortir véhicule vite.", mistake: "S'arrêter sur voie." },
        { q: "Appel urgence autoroute :", opts: ["Borne SOS/112", "Attendre", "Marcher", "Réparer"], correct: 0, exp: "Utiliser borne orange ou 112.", tip: "Indiquer position précise.", mistake: "Partir chercher aide." },
        { q: "Panne tunnel : que faire ?", opts: ["Arrêt, moteur coupé, sortir", "Continuer", "Rester dedans", "Faire demi-tour"], correct: 0, exp: "Arrêt immédiat, moteur coupé, évacuation.", tip: "Utiliser issues secours.", mistake: "Rester dans tunnel." },
      ]
    },
    "Conducteur": {
      vigilance: [
        { q: "Vision rétroviseur intérieur :", opts: ["Partielle, angle mort", "Tout arrière", "180°", "Route seule"], correct: 0, exp: "Rétroviseurs ne montrent pas tout : angles morts.", tip: "Tourner tête avant déboîter.", mistake: "Se fier uniquement rétros." },
        { q: "Angle mort : où ?", opts: ["Côtés arrière", "Devant", "Nulle part", "Partout"], correct: 0, exp: "Angles morts sur côtés arrière véhicule.", tip: "Vérifier en tournant tête.", mistake: "Ignorer angles morts." },
        { q: "Vérification angles morts :", opts: ["Tourner la tête", "Rétros suffisent", "Inutile", "Klaxonner"], correct: 0, exp: "Tourner tête obligatoire avant manœuvre.", tip: "Rapide coup d'œil.", mistake: "Rétros seuls." },
        { q: "Fatigue au volant : signes ?", opts: ["Bâillements, yeux piquent", "Rien", "Excitation", "Faim"], correct: 0, exp: "Fatigue = bâillements, yeux lourds, attention réduite.", tip: "Pause toutes les 2h.", mistake: "Continuer fatigué." },
      ],
      telephone: [
        { q: "Téléphone en conduisant (sans kit) :", opts: ["Interdit et sanctionné", "Autorisé court", "OK ville", "OK arrêt moteur on"], correct: 0, exp: "Téléphone main = interdit : 135€ + 3 points.", tip: "Même arrêt moteur tournant interdit.", mistake: "Répondre vite." },
        { q: "Kit mains-libres : autorisé ?", opts: ["Oui mais déconseillé", "Interdit", "Obligatoire", "Recommandé"], correct: 0, exp: "Kit autorisé mais réduit vigilance.", tip: "Éviter conversations longues.", mistake: "Téléphoner longuement." },
        { q: "Oreillette/casque en conduisant :", opts: ["Interdit", "Autorisé", "Obligatoire", "Recommandé"], correct: 0, exp: "Oreillette interdite (réduit vigilance sonore).", tip: "Besoin d'entendre environnement.", mistake: "Porter oreillette." },
        { q: "Smartphone GPS en main :", opts: ["Interdit", "Autorisé", "OK si GPS", "Recommandé"], correct: 0, exp: "Smartphone en main = interdit même pour GPS.", tip: "Support obligatoire.", mistake: "Tenir pour GPS." },
      ],
      fatigue: [
        { q: "Fatigue : fréquence pauses recommandée ?", opts: ["Toutes les 2h", "Toutes les 4h", "Jamais", "Toutes les heures"], correct: 0, exp: "Pause 15-20 min toutes les 2h recommandée.", tip: "Étirements, marche.", mistake: "Conduire 5h d'affilée." },
        { q: "Somnolence : meilleure solution ?", opts: ["Arrêt et repos", "Café", "Fenêtre ouverte", "Radio forte"], correct: 0, exp: "Somnolence = arrêt immédiat et repos.", tip: "Café temporaire seulement.", mistake: "Continuer avec café." },
        { q: "Conduite nuit : risques ?", opts: ["Fatigue + visibilité", "Aucun", "Meilleur", "Plus rapide"], correct: 0, exp: "Nuit = fatigue accrue + visibilité réduite.", tip: "Pauses fréquentes.", mistake: "Rouler vite car vide." },
        { q: "Médicaments et conduite :", opts: ["Vérifier pictogramme", "Toujours OK", "Interdits tous", "Aucun risque"], correct: 0, exp: "Vérifier pictogramme (niveaux 1, 2, 3).", tip: "Niveau 3 = interdit conduire.", mistake: "Ignorer pictogramme." },
      ],
      anglesMorts: [
        { q: "Changer de file : vérification ?", opts: ["Rétro + angle mort", "Rétro seul", "Rien", "Klaxonner"], correct: 0, exp: "Rétro + tourner tête obligatoire.", tip: "Double vérification.", mistake: "Rétro uniquement." },
        { q: "Moto dans angle mort :", opts: ["Très fréquent", "Rare", "Impossible", "Jamais"], correct: 0, exp: "Motos souvent dans angles morts.", tip: "Vigilance maximale.", mistake: "Ne pas vérifier." },
        { q: "Rétroviseurs bien réglés :", opts: ["Éliminent pas angles morts", "Éliminent angles morts", "Inutiles", "Suffisent"], correct: 0, exp: "Même bien réglés, angles morts subsistent.", tip: "Toujours tourner tête.", mistake: "Compter sur réglage seul." },
      ]
    },
    "Route": {
      conditions: [
        { q: "Brouillard visibilité < 50m : vitesse max ?", opts: ["50 km/h", "90 km/h", "70 km/h", "30 km/h"], correct: 0, exp: "Brouillard épais (<50m) = 50 km/h maximum.", tip: "Feux brouillard + croisement.", mistake: "Rouler à 90." },
        { q: "Aquaplaning : que faire ?", opts: ["Débrayer, pas freiner, volant droit", "Freiner fort", "Accélérer", "Tourner gauche"], correct: 0, exp: "Lever pied, débrayer, tenir volant, PAS freiner.", tip: "Laisser ralentir naturellement.", mistake: "Freiner brusquement." },
        { q: "Neige : équipements obligatoires zones ?", opts: ["Pneus hiver/chaînes", "Rien", "Chaînes seules", "Pneus été"], correct: 0, exp: "Zones montagne : pneus hiver OU chaînes obligatoires.", tip: "Panneau spécifique.", mistake: "Pneus été." },
        { q: "Verglas : conduite adaptée ?", opts: ["Très lente, anticipation max", "Normale", "Rapide", "Freiner fort"], correct: 0, exp: "Verglas = vitesse minimale, douceur totale.", tip: "Adhérence quasi nulle.", mistake: "Conduire normalement." },
      ],
      autoroute: [
        { q: "Autoroute : voie la plus à gauche pour ?", opts: ["Dépassement uniquement", "Rouler", "Lent", "Tous"], correct: 0, exp: "Voie gauche = dépassement, revenir à droite après.", tip: "Ne pas squatter gauche.", mistake: "Rester à gauche." },
        { q: "Arrêt sur autoroute autorisé :", opts: ["BAU panne/urgence", "N'importe où", "Voie circulation", "Jamais"], correct: 0, exp: "Arrêt uniquement BAU et urgence.", tip: "Sinon aire de repos.", mistake: "S'arrêter pour autre chose." },
        { q: "Insertion sur autoroute : priorité ?", opts: ["Céder aux véhicules", "Être prioritaire", "Klaxonner", "Forcer"], correct: 0, exp: "S'insérer = céder passage véhicules sur voie.", tip: "Adapter vitesse.", mistake: "Forcer insertion." },
        { q: "Sortie autoroute : voie ?", opts: ["Droite progressivement", "Gauche", "Centre", "Brutalement"], correct: 0, exp: "Sortir = se rabattre progressivement à droite.", tip: "Anticiper sortie.", mistake: "Traverser au dernier moment." },
      ],
      tunnel: [
        { q: "Tunnel : distance sécurité ?", opts: ["Augmentée", "Normale", "Réduite", "Aucune"], correct: 0, exp: "Tunnel = augmenter distance (visibilité/échappement difficile).", tip: "Risque incendie.", mistake: "Coller véhicule." },
        { q: "Panne dans tunnel :", opts: ["Arrêt, moteur coupé, évacuer", "Réparer", "Rester dedans", "Continuer"], correct: 0, exp: "Arrêt immédiat, couper moteur, évacuer par issues.", tip: "Risque asphyxie/incendie.", mistake: "Rester dans véhicule." },
        { q: "Feux dans tunnel :", opts: ["Croisement obligatoire", "Route", "Rien", "Brouillard"], correct: 0, exp: "Feux de croisement obligatoires en tunnel.", tip: "Même jour.", mistake: "Rouler sans feux." },
        { q: "Demi-tour en tunnel :", opts: ["Strictement interdit", "Autorisé", "Si urgence", "Recommandé"], correct: 0, exp: "Demi-tour tunnel = interdit (très dangereux).", tip: "Continuer quoi qu'il arrive.", mistake: "Faire demi-tour." },
      ],
      aquaplaning: [
        { q: "Cause aquaplaning :", opts: ["Eau + vitesse + pneus", "Vitesse seule", "Pneus seuls", "Hasard"], correct: 0, exp: "Aquaplaning = eau sur route + vitesse élevée + pneus usés.", tip: "Combinaison facteurs.", mistake: "Blâmer un seul facteur." },
        { q: "Prévenir aquaplaning :", opts: ["Ralentir, pneus OK", "Accélérer", "Freiner", "Rien"], correct: 0, exp: "Prévention = réduire vitesse + pneus bon état.", tip: "Vigilance flaques.", mistake: "Rouler vite pluie." },
        { q: "Sensation aquaplaning :", opts: ["Perte adhérence/direction", "Rien", "Meilleure tenue", "Accélération"], correct: 0, exp: "Sensation direction légère, perte contrôle.", tip: "Réagir doucement.", mistake: "Mouvements brusques." },
      ]
    },
    "Mécanique": {
      entretien: [
        { q: "Contrôle technique : fréquence ?", opts: ["Tous les 2 ans (>4 ans)", "Annuel", "Tous les 5 ans", "Jamais"], correct: 0, exp: "CT obligatoire tous les 2 ans pour véhicule > 4 ans.", tip: "Amende si défaut.", mistake: "Oublier CT." },
        { q: "Niveau huile moteur : quand vérifier ?", opts: ["Moteur froid", "Moteur chaud", "Jamais", "En roulant"], correct: 0, exp: "Vérifier huile moteur froid (jauge fiable).", tip: "Mensuel recommandé.", mistake: "Vérifier chaud." },
        { q: "Liquide refroidissement : rôle ?", opts: ["Éviter surchauffe moteur", "Freiner", "Nettoyer", "Rien"], correct: 0, exp: "Liquide refroidissement évite surchauffe moteur.", tip: "Vérifier niveau régulièrement.", mistake: "Ignorer niveau." },
        { q: "Vidange moteur : pourquoi ?", opts: ["Renouveler huile usée", "Esthétique", "Obligatoire annuel", "Inutile"], correct: 0, exp: "Vidange élimine huile usée, protège moteur.", tip: "Selon km ou temps.", mistake: "Reporter indéfiniment." },
      ],
      pneus: [
        { q: "Pression pneus : vérifier ?", opts: ["À froid", "À chaud", "Peu importe", "Jamais"], correct: 0, exp: "Pression pneus se vérifie à froid.", tip: "Mensuel + avant trajets.", mistake: "Vérifier après roulage." },
        { q: "Profondeur sculpture minimale légale :", opts: ["1,6 mm", "3 mm", "5 mm", "0 mm"], correct: 0, exp: "Minimum légal = 1,6 mm (témoin d'usure).", tip: "Recommandé > 3 mm hiver.", mistake: "Pneus lisses." },
        { q: "Pneus usés : risques ?", opts: ["Adhérence réduite + aquaplaning", "Aucun", "Meilleur", "Économie"], correct: 0, exp: "Pneus usés = perte adhérence, aquaplaning.", tip: "Danger pluie.", mistake: "Garder pneus lisses." },
        { q: "Permutation pneus : pourquoi ?", opts: ["Usure homogène", "Esthétique", "Inutile", "Obligatoire"], correct: 0, exp: "Permutation = usure régulière, prolonge durée vie.", tip: "Tous les 10-15 000 km.", mistake: "Ne jamais permuter." },
      ],
      freins: [
        { q: "Freins qui grincent :", opts: ["Vérifier rapidement", "Normal", "Ignorer", "Attendre panne"], correct: 0, exp: "Grincement = usure possible, vérifier.", tip: "Sécurité vitale.", mistake: "Ignorer bruit." },
        { q: "Pédale frein molle :", opts: ["Danger, garage immédiat", "Normal", "Attendre", "Pomper"], correct: 0, exp: "Pédale molle = circuit frein défaillant, danger.", tip: "Arrêt immédiat.", mistake: "Continuer conduire." },
        { q: "Liquide de frein : rôle ?", opts: ["Transmet pression freinage", "Refroidir", "Nettoyer", "Rien"], correct: 0, exp: "Liquide transmet pression pédale vers freins.", tip: "Vérifier niveau.", mistake: "Ignorer liquide frein." },
        { q: "ABS : fonction ?", opts: ["Évite blocage roues", "Freine mieux", "Inutile", "Accélère"], correct: 0, exp: "ABS évite blocage roues, garde direction.", tip: "Appuyer fort pédale, ABS gère.", mistake: "Pomper pédale avec ABS." },
      ],
      voyants: [
        { q: "Voyant rouge moteur s'allume :", opts: ["Arrêter rapidement", "Continuer", "Accélérer", "Vérifier dans 100 km"], correct: 0, exp: "Voyant rouge = danger immédiat, arrêt impératif.", tip: "Rouge = stop. Orange = surveillance.", mistake: "Continuer jusqu'au garage." },
        { q: "Voyant orange moteur :", opts: ["Surveiller, garage proche", "Panique", "Ignorer", "Arrêt immédiat"], correct: 0, exp: "Voyant orange = problème à surveiller, garage.", tip: "Pas urgence immédiate.", mistake: "Ignorer complètement." },
        { q: "Voyant batterie allumé :", opts: ["Problème charge, vérifier", "Normal", "Esthétique", "Rien"], correct: 0, exp: "Voyant batterie = défaut charge (alternateur/batterie).", tip: "Risque panne.", mistake: "Ignorer." },
        { q: "Voyant pression pneu :", opts: ["Vérifier gonflage", "Ignorer", "Normal", "Crevaison"], correct: 0, exp: "Voyant pneu = vérifier pression (perte possible).", tip: "Contrôler tous pneus.", mistake: "Ne rien faire." },
      ]
    },
    "Premiers Secours": {
      urgence: [
        { q: "Numéro urgence européen ?", opts: ["112", "15", "17", "18"], correct: 0, exp: "112 = numéro urgence unique européen.", tip: "Fonctionne même sans réseau opérateur.", mistake: "Oublier 112." },
        { q: "Protéger lieu accident : comment ?", opts: ["Triangle, warnings, baliser", "Rien", "Partir", "Filmer"], correct: 0, exp: "Triangle 30m, warnings, baliser danger.", tip: "Éviter suraccident.", mistake: "Ne pas protéger." },
        { q: "Ordre actions accident :", opts: ["Protéger, Alerter, Secourir", "Secourir d'abord", "Alerter seul", "Partir"], correct: 0, exp: "PAS : Protéger, Alerter, Secourir.", tip: "Ordre vital.", mistake: "Secourir avant protéger." },
        { q: "Alerter secours : infos à donner ?", opts: ["Lieu, victimes, dangers", "Nom seul", "Rien", "Numéro plaque"], correct: 0, exp: "Préciser lieu exact, nombre/état victimes, dangers.", tip: "Rester en ligne si demandé.", mistake: "Raccrocher vite." },
      ],
      PLS: [
        { q: "Victime inconsciente qui respire :", opts: ["PLS", "Bouche-à-bouche", "Massage cardiaque", "Sur le dos"], correct: 0, exp: "Inconscient + respire = PLS éviter étouffement.", tip: "Protège voies aériennes.", mistake: "Laisser sur dos." },
        { q: "PLS : pourquoi ?", opts: ["Éviter étouffement langue/vomi", "Confort", "Esthétique", "Inutile"], correct: 0, exp: "PLS empêche langue d'obstruer gorge, vomi d'étouffer.", tip: "Position sécurisée.", mistake: "Penser inutile." },
        { q: "Victime inconsciente NE respire PAS :", opts: ["Massage cardiaque + 15/18", "PLS", "Attendre", "Rien"], correct: 0, exp: "Inconscient sans respiration = massage cardiaque immédiat + appel 15/18.", tip: "Chaîne survie.", mistake: "Mettre en PLS." },
        { q: "Fréquence massage cardiaque :", opts: ["100-120/min", "50/min", "200/min", "Au hasard"], correct: 0, exp: "Rythme massage ≈ 100-120 compressions/minute.", tip: "Rythme Staying Alive.", mistake: "Trop lent." },
      ],
      hemorragie: [
        { q: "Victime saigne abondamment bras :", opts: ["Compression directe plaie", "Garrot immédiat", "Attendre secours", "Nettoyer d'abord"], correct: 0, exp: "Hémorragie = compression directe forte et continue.", tip: "Garrot = dernier recours.", mistake: "Garrot systématique." },
        { q: "Garrot : quand utiliser ?", opts: ["Si compression inefficace", "Toujours", "Jamais", "D'abord"], correct: 0, exp: "Garrot seulement si compression ne suffit pas.", tip: "Risque amputation.", mistake: "Garrot en premier." },
        { q: "Hémorragie : élever membre ?", opts: ["Oui si possible", "Non", "Toujours", "Jamais"], correct: 0, exp: "Élever membre réduit saignement (si pas fracture).", tip: "Complète compression.", mistake: "Élever si fracture." },
        { q: "Saignement nez abondant :", opts: ["Pencher tête avant, comprimer", "Tête arrière", "Rien", "Coucher"], correct: 0, exp: "Tête en avant, pincer narine, comprimer.", tip: "Éviter avaler sang.", mistake: "Tête en arrière." },
      ],
      accident: [
        { q: "Victime dans véhicule accidenté :", opts: ["Ne pas bouger sauf danger", "Sortir immédiatement", "Laisser seule", "Déplacer toujours"], correct: 0, exp: "Ne bouger que si danger immédiat (feu, explosion).", tip: "Lésions aggravées si déplacé.", mistake: "Sortir systématiquement." },
        { q: "Casque motard accidenté :", opts: ["Ne pas retirer sauf nécessité", "Retirer toujours", "Jeter", "Ignorer"], correct: 0, exp: "Casque : ne retirer que si inconscient sans respiration.", tip: "Risque lésion cervicale.", mistake: "Retirer systématiquement." },
        { q: "Brûlure grave : refroidir ?", opts: ["Eau froide 15 min", "Glace", "Rien", "Huile"], correct: 0, exp: "Brûlure = eau froide (pas glacée) 15 min minimum.", tip: "Limite profondeur brûlure.", mistake: "Mettre glace directe." },
        { q: "Fracture apparente : action ?", opts: ["Immobiliser, ne pas bouger", "Réduire fracture", "Tirer membre", "Masser"], correct: 0, exp: "Fracture = immobiliser dans position trouvée.", tip: "Attendre secours.", mistake: "Essayer réaligner." },
      ]
    },
    "Éco-conduite": {
      consommation: [
        { q: "Pour consommer moins :", opts: ["Conduite souple anticipée", "Accélérations brutales", "Fenêtres ouvertes autoroute", "Point mort"], correct: 0, exp: "Conduite souple, anticipation = -20% consommation.", tip: "Anticiper feux, ralentissements.", mistake: "Vitesse rapide." },
        { q: "Rapport de vitesse élevé :", opts: ["Réduit consommation", "Augmente consommation", "Aucun effet", "Casse moteur"], correct: 0, exp: "Rapport élevé (régime bas) = moins de consommation.", tip: "Passer vitesse tôt.", mistake: "Sur-régime." },
        { q: "Démarrage moteur froid :", opts: ["Rouler doucement direct", "Chauffer 5 min", "Accélérer fort", "Attendre 10 min"], correct: 0, exp: "Démarrer et rouler doucement, moteur chauffe mieux.", tip: "Pas besoin chauffer à l'arrêt.", mistake: "Chauffer longtemps." },
        { q: "Coffre chargé inutilement :", opts: ["Augmente consommation", "Réduit consommation", "Aucun effet", "Meilleur"], correct: 0, exp: "Poids inutile = surconsommation.", tip: "Vider coffre régulièrement.", mistake: "Garder objets lourds." },
      ],
      anticipation: [
        { q: "Feu rouge au loin :", opts: ["Lever pied, laisser rouler", "Accélérer", "Freiner fort", "Point mort"], correct: 0, exp: "Anticiper feu = lever pied, frein moteur.", tip: "Économise carburant et freins.", mistake: "Accélérer puis freiner." },
        { q: "Descente : comment économiser ?", opts: ["Laisser rouler en vitesse", "Point mort", "Freiner continu", "Accélérer"], correct: 0, exp: "Descente en vitesse (frein moteur) = injection coupée.", tip: "Économie carburant.", mistake: "Point mort." },
        { q: "Ralentissement prévisible :", opts: ["Anticiper, lever pied", "Continuer vitesse", "Freiner tard", "Accélérer"], correct: 0, exp: "Anticipation = lever pied tôt, moins de freinage.", tip: "Économie + confort.", mistake: "Freiner brusquement." },
        { q: "Régulateur vitesse autoroute :", opts: ["Économise si régulier", "Consomme plus", "Inutile", "Dangereux"], correct: 0, exp: "Régulateur = vitesse constante, économie.", tip: "Efficace sur plat.", mistake: "Ne jamais utiliser." },
      ],
      climatisation: [
        { q: "Climatisation augmente consommation :", opts: ["15-25%", "5%", "50%", "0%"], correct: 0, exp: "Clim = +15 à 25% consommation en ville.", tip: "Aération préférable ville.", mistake: "Laisser clim permanence." },
        { q: "Clim : usage optimal ?", opts: ["Route/autoroute seulement", "Toujours", "Jamais", "Ville uniquement"], correct: 0, exp: "Clim sur route (fenêtres = résistance aéro).", tip: "Ville : fenêtres. Route : clim.", mistake: "Clim ville + fenêtres autoroute." },
        { q: "Fenêtres ouvertes autoroute :", opts: ["Augmente consommation", "Réduit consommation", "Neutre", "Meilleur"], correct: 0, exp: "Fenêtres ouvertes haute vitesse = résistance air, surconso.", tip: "Clim plus économique.", mistake: "Fenêtres ouvertes pensant économiser." },
        { q: "Préchauffage habitacle moteur éteint :", opts: ["Surconsommation", "Économie", "Neutre", "Recommandé"], correct: 0, exp: "Préchauffer moteur éteint = batterie, pas efficace.", tip: "Rouler pour chauffer.", mistake: "Laisser tourner moteur." },
      ],
      vitesse: [
        { q: "Réduire vitesse 10 km/h autoroute :", opts: ["Économie notable", "Aucune différence", "Consomme plus", "Dangereux"], correct: 0, exp: "Réduire 10 km/h (130→120) = -10% consommation.", tip: "Efficacité maximale.", mistake: "Rouler toujours vitesse max." },
        { q: "Vitesse optimale économie :", opts: ["70-90 km/h", "130 km/h", "50 km/h", "150 km/h"], correct: 0, exp: "Consommation optimale entre 70-90 km/h.", tip: "Selon véhicule.", mistake: "Vitesse maximale." },
        { q: "Résistance aérodynamique : augmente comment ?", opts: ["Carré de la vitesse", "Linéairement", "Pas d'augmentation", "Au hasard"], correct: 0, exp: "Résistance air = carré vitesse (doubler vitesse = ×4 résistance).", tip: "Vitesse = ennemi consommation.", mistake: "Penser linéaire." },
        { q: "Galerie toit inutilisée :", opts: ["Surconsommation", "Neutre", "Économie", "Recommandé"], correct: 0, exp: "Galerie/coffre toit = résistance air, +10-20% conso.", tip: "Retirer si inutile.", mistake: "Laisser galerie." },
      ]
    }
  };

  let questionId = 1;
  const allQuestions = [];

  sections.forEach(section => {
    const templates = section.templates;
    let questionsAdded = 0;
    
    while (questionsAdded < section.count) {
      templates.forEach(template => {
        if (questionsAdded >= section.count) return;
        
        const typeQuestions = questionBank[section.category]?.[template.type] || [];
        if (typeQuestions.length === 0) return;
        
        const questionData = typeQuestions[questionsAdded % typeQuestions.length];
        
        allQuestions.push({
          id: questionId++,
          category: section.category,
          difficulty: template.difficulty,
          question: questionData.q,
          ...(questionData.img && { image: questionData.img }),
          options: questionData.opts,
          correctAnswer: questionData.correct,
          explanation: questionData.exp,
          tip: questionData.tip,
          commonMistake: questionData.mistake
        });
        
        questionsAdded++;
      });
    }
  });

  return allQuestions;
};

const QUESTIONS_DB = generateQuestionsDB();

// Legacy questions kept for compatibility
const LEGACY_QUESTIONS = [
  // SIGNALISATION (15 questions)
  {
    id: 1,
    category: "Signalisation",
    difficulty: 1,
    question: "Que signifie ce panneau ?",
    image: "assets/panneau_stop.svg",
    options: [
      "Arrêt obligatoire",
      "Ralentir",
      "Céder le passage",
      "Intersection",
    ],
    correctAnswer: 0,
    explanation: "Le panneau STOP impose un arrêt complet avant la ligne.",
    tip: "STOP = Arrêt obligatoire, même si la voie est libre.",
    commonMistake: "Ralentir sans s'arrêter complètement.",
  },
  {
    id: 2,
    category: "Signalisation",
    difficulty: 2,
    question: "Ce panneau indique :",
    image: "assets/panneau_route_prioritaire.svg",
    options: [
      "Route prioritaire",
      "Attention danger",
      "Parking autorisé",
      "Zone résidentielle",
    ],
    correctAnswer: 0,
    explanation: "Le losange jaune signale une route prioritaire.",
    tip: "Vous êtes prioritaire sur les intersections suivantes.",
    commonMistake: "Confondre avec un panneau de danger.",
  },
  {
    id: 3,
    category: "Signalisation",
    difficulty: 1,
    question: "Quelle est la signification de ce panneau ?",
    image: "assets/panneau_cedez_le_passage.svg",
    options: ["Cédez le passage", "Stop", "Priorité à droite", "Sens interdit"],
    correctAnswer: 0,
    explanation:
      "Triangle inversé = céder le passage aux véhicules prioritaires.",
    tip: "Ralentir et céder si nécessaire, mais pas d'arrêt obligatoire.",
    commonMistake: "S'arrêter systématiquement comme au STOP.",
  },
  {
    id: 4,
    category: "Signalisation",
    difficulty: 1,
    question: "Cette limitation indique :",
    image: "assets/panneau_limitation_50.svg",
    options: [
      "50 km/h maximum",
      "50 km/h minimum",
      "50 mètres",
      "Poids 50 tonnes",
    ],
    correctAnswer: 0,
    explanation: "Cercle rouge = interdiction. Ici, vitesse maximale 50 km/h.",
    tip: "En agglomération, 50 km/h est la règle générale.",
    commonMistake: "Dépasser légèrement 'juste de 5 km/h'.",
  },
  {
    id: 5,
    category: "Signalisation",
    difficulty: 2,
    question: "À un rond-point, vous devez :",
    image: "assets/panneau_rond_point.svg",
    options: [
      "Tourner à gauche",
      "Céder le passage aux véhicules déjà engagés",
      "Être prioritaire",
      "Klaxonner",
    ],
    correctAnswer: 1,
    explanation: "Priorité aux véhicules circulant dans le rond-point.",
    tip: "Toujours céder le passage à gauche au rond-point.",
    commonMistake: "S'engager sans vérifier à gauche.",
  },
  {
    id: 6,
    category: "Signalisation",
    difficulty: 1,
    question: "Ce panneau signifie :",
    image: "assets/panneau_stationnement_interdit.svg",
    options: [
      "Stationnement interdit",
      "Arrêt interdit",
      "Sens interdit",
      "Zone bleue",
    ],
    correctAnswer: 0,
    explanation: "Panneau d'interdiction de stationner (une barre rouge).",
    tip: "Une barre = stationnement interdit. Deux barres = arrêt interdit.",
    commonMistake: "Confondre avec l'arrêt interdit (deux barres).",
  },
  {
    id: 7,
    category: "Signalisation",
    difficulty: 2,
    question: "Un feu orange signifie :",
    options: [
      "Accélérer pour passer",
      "S'arrêter sauf si dangereux",
      "Continuer normalement",
      "Klaxonner",
    ],
    correctAnswer: 1,
    explanation:
      "Feu orange = arrêt obligatoire sauf si impossible sans danger.",
    tip: "Orange = stop, sauf si vous êtes trop près pour freiner.",
    commonMistake: "Accélérer pour 'griller' le feu orange.",
  },
  {
    id: 8,
    category: "Signalisation",
    difficulty: 3,
    question: "Un panneau triangulaire pointe vers le haut indique :",
    options: [
      "Une obligation",
      "Un danger",
      "Une interdiction",
      "Une indication",
    ],
    correctAnswer: 1,
    explanation:
      "Triangle pointe en haut = signaux de danger (virage, école, etc.).",
    tip: "Forme triangulaire rouge = attention danger à venir.",
    commonMistake: "Confondre avec les panneaux d'obligation (ronds bleus).",
  },

  // PRIORITÉS (10 questions)
  {
    id: 10,
    category: "Priorités",
    difficulty: 2,
    question: "À une intersection sans panneau, qui est prioritaire ?",
    options: [
      "Celui qui vient de droite",
      "Celui qui vient de gauche",
      "Le plus gros véhicule",
      "Celui qui klaxonne",
    ],
    correctAnswer: 0,
    explanation:
      "Règle de base : priorité à droite en l'absence de signalisation.",
    tip: "Pas de panneau ? Priorité à droite !",
    commonMistake: "Penser être prioritaire sur une grande route.",
  },
  {
    id: 11,
    category: "Priorités",
    difficulty: 3,
    question:
      "Qui est prioritaire : piéton sur passage ou véhicule prioritaire en urgence ?",
    options: [
      "Le piéton toujours",
      "Véhicule prioritaire",
      "Dépend de la situation",
      "Le plus rapide",
    ],
    correctAnswer: 0,
    explanation: "Le piéton engagé sur un passage est TOUJOURS prioritaire.",
    tip: "Piéton > Tout, même ambulance.",
    commonMistake: "Penser que l'ambulance peut forcer le passage.",
  },
  {
    id: 12,
    category: "Priorités",
    difficulty: 2,
    question:
      "Vous êtes sur route prioritaire. Un véhicule arrive de droite sans céder :",
    options: [
      "Vous passez, vous êtes prioritaire",
      "Vous ralentissez et vérifiez",
      "Vous klaxonnez fort",
      "Vous accélérez",
    ],
    correctAnswer: 1,
    explanation:
      "Priorité ne dispense pas de prudence. Anticiper l'erreur d'autrui.",
    tip: "Avoir la priorité ≠ avoir raison dans l'accident.",
    commonMistake: "Foncer car 'j'ai la priorité'.",
  },

  // VITESSE & LIMITATIONS (12 questions)
  {
    id: 20,
    category: "Vitesse",
    difficulty: 1,
    question: "Vitesse maximale en agglomération pour un véhicule léger ?",
    options: ["50 km/h", "60 km/h", "70 km/h", "80 km/h"],
    correctAnswer: 0,
    explanation: "50 km/h en ville, sauf indication contraire.",
    tip: "Panneau agglomération = 50 km/h automatique.",
    commonMistake: "Rouler à 60 km/h 'car tout le monde le fait'.",
  },
  {
    id: 21,
    category: "Vitesse",
    difficulty: 2,
    question: "Sur autoroute par temps de pluie, la vitesse maximale est :",
    options: ["130 km/h", "110 km/h", "90 km/h", "50 km/h"],
    correctAnswer: 1,
    explanation: "Pluie : -20 km/h sur autoroute (130 → 110 km/h).",
    tip: "Pluie = réduire de 20 km/h sur autoroute et voie rapide.",
    commonMistake: "Garder 130 km/h sous la pluie.",
  },
  {
    id: 22,
    category: "Vitesse",
    difficulty: 3,
    question: "Jeune conducteur (permis < 3 ans) sur autoroute : vitesse max ?",
    options: ["130 km/h", "110 km/h", "100 km/h", "90 km/h"],
    correctAnswer: 1,
    explanation:
      "Jeune conducteur : 110 km/h max sur autoroute (au lieu de 130).",
    tip: "Disque A obligatoire pendant 3 ans avec limitations réduites.",
    commonMistake: "Rouler à 130 km/h dès le permis obtenu.",
  },
  {
    id: 23,
    category: "Vitesse",
    difficulty: 2,
    question: "Distance de sécurité minimale sur autoroute à 130 km/h ?",
    options: ["1 seconde", "2 secondes", "3 secondes", "5 secondes"],
    correctAnswer: 1,
    explanation:
      "Règle des 2 secondes : repère fixe, compter 2 sec avant de passer.",
    tip: "Dire 'un crocodile, deux crocodiles' entre vous et le véhicule devant.",
    commonMistake: "Coller le véhicule devant (< 1 seconde).",
  },

  // ALCOOL, DROGUES, MÉDICAMENTS (8 questions)
  {
    id: 30,
    category: "Alcool & Drogues",
    difficulty: 1,
    question: "Taux d'alcoolémie maximum autorisé (conducteur confirmé) ?",
    options: ["0,5 g/L de sang", "0,8 g/L", "0,2 g/L", "0 g/L"],
    correctAnswer: 0,
    explanation: "0,5 g/L max pour conducteur confirmé, 0,2 g/L pour jeune.",
    tip: "≈ 2 verres standard pour 0,5 g/L (mais varie selon personne).",
    commonMistake: "Penser pouvoir boire 3-4 verres sans dépasser.",
  },
  {
    id: 31,
    category: "Alcool & Drogues",
    difficulty: 2,
    question: "Pour éliminer l'alcool, le plus efficace est :",
    options: [
      "Boire du café",
      "Attendre (temps)",
      "Manger beaucoup",
      "Prendre une douche froide",
    ],
    correctAnswer: 1,
    explanation: "Seul le temps élimine l'alcool. Rien d'autre ne fonctionne.",
    tip: "0,15 g/L par heure environ. Donc 3h pour 0,5 g/L.",
    commonMistake: "Croire que café ou douche 'dégrisent'.",
  },
  {
    id: 32,
    category: "Alcool & Drogues",
    difficulty: 3,
    question: "Dépistage de drogue positif, même sans signes d'ivresse :",
    options: [
      "Amende simple",
      "Retrait de permis possible + prison",
      "Avertissement",
      "Stage obligatoire",
    ],
    correctAnswer: 1,
    explanation:
      "Conduite sous stupéfiants = délit : 2 ans prison, 4500€, retrait permis.",
    tip: "Cannabis détectable plusieurs jours/semaines après consommation.",
    commonMistake: "Penser que 'ça va, j'ai fumé il y a 2 jours'.",
  },

  // SÉCURITÉ ROUTIÈRE (12 questions)
  {
    id: 40,
    category: "Sécurité",
    difficulty: 1,
    question: "Le port de la ceinture est obligatoire :",
    options: [
      "Seulement sur autoroute",
      "À l'avant uniquement",
      "À l'avant et à l'arrière",
      "Seulement hors ville",
    ],
    correctAnswer: 2,
    explanation: "Ceinture obligatoire partout, avant ET arrière.",
    tip: "Ceinture = -50% de mortalité en cas d'accident.",
    commonMistake: "Détacher la ceinture en ville ou sur courtes distances.",
  },
  {
    id: 41,
    category: "Sécurité",
    difficulty: 2,
    question: "Enfant de 8 ans doit être installé :",
    options: [
      "Siège auto adapté ou rehausseur",
      "Ceinture adulte",
      "À l'avant sans siège",
      "Debout à l'arrière",
    ],
    correctAnswer: 0,
    explanation:
      "Jusqu'à 10 ans ou 135 cm : siège auto/rehausseur obligatoire.",
    tip: "Choisir siège homologué selon poids et taille de l'enfant.",
    commonMistake:
      "Mettre ceinture adulte directement pour un enfant de 8 ans.",
  },
  {
    id: 42,
    category: "Sécurité",
    difficulty: 2,
    question: "En cas de crevaison sur autoroute, vous devez :",
    options: [
      "Réparer sur place",
      "Mettre gilet + triangle, se mettre en sécurité",
      "Appeler sans sortir",
      "Continuer doucement",
    ],
    correctAnswer: 1,
    explanation:
      "Gilet jaune, triangle à 30m, sortir du véhicule côté sécurité.",
    tip: "Se mettre derrière glissière, ne JAMAIS rester dans la voiture.",
    commonMistake: "Rester dans le véhicule en attendant les secours.",
  },

  // CONDUCTEUR & USAGERS (8 questions)
  {
    id: 50,
    category: "Conducteur",
    difficulty: 2,
    question: "Vision d'un rétroviseur intérieur :",
    options: [
      "Tout l'arrière du véhicule",
      "Une partie, avec angle mort",
      "180° complet",
      "Seulement la route",
    ],
    correctAnswer: 1,
    explanation: "Rétroviseurs ne montrent pas tout : angles morts existent.",
    tip: "Toujours tourner la tête avant de changer de file.",
    commonMistake: "Se fier uniquement aux rétroviseurs pour déboîter.",
  },
  {
    id: 51,
    category: "Conducteur",
    difficulty: 1,
    question: "Au téléphone en conduisant (sans kit mains-libres) :",
    options: [
      "Autorisé si court",
      "Interdit et sanctionné",
      "Autorisé en ville",
      "Autorisé à l'arrêt moteur tournant",
    ],
    correctAnswer: 1,
    explanation: "Téléphone en main = interdit : 135€ + 3 points.",
    tip: "Même à l'arrêt moteur tournant c'est interdit !",
    commonMistake: "Répondre 'vite' en pensant que ça passe.",
  },

  // ROUTE & ENVIRONNEMENT (10 questions)
  {
    id: 60,
    category: "Route",
    difficulty: 2,
    question: "Par temps de brouillard (visibilité < 50m), vitesse maximum ?",
    options: ["90 km/h", "70 km/h", "50 km/h", "30 km/h"],
    correctAnswer: 2,
    explanation: "Brouillard épais (< 50m) = 50 km/h maximum.",
    tip: "Feux de brouillard + feux de croisement obligatoires.",
    commonMistake: "Rouler à 90 km/h avec brouillard.",
  },
  {
    id: 61,
    category: "Route",
    difficulty: 3,
    question: "Aquaplaning : que faire ?",
    options: [
      "Freiner fort",
      "Accélérer",
      "Débrayer, ne pas freiner, tenir le volant",
      "Tourner à gauche",
    ],
    correctAnswer: 2,
    explanation:
      "Aquaplaning : lever le pied, débrayer, tenir le volant droit, ne PAS freiner.",
    tip: "Laisser le véhicule ralentir naturellement pour retrouver adhérence.",
    commonMistake: "Freiner brusquement = perte totale de contrôle.",
  },

  // MÉCANIQUE & ENTRETIEN (8 questions)
  {
    id: 70,
    category: "Mécanique",
    difficulty: 2,
    question: "Pression des pneus : à vérifier :",
    options: [
      "À chaud après trajet",
      "À froid",
      "Peu importe",
      "Seulement en garage",
    ],
    correctAnswer: 1,
    explanation: "Pression pneus se vérifie à froid (avant roulage).",
    tip: "Vérifier pression mensuelle + avant longs trajets.",
    commonMistake: "Vérifier après avoir roulé (pression gonflée par chaleur).",
  },
  {
    id: 71,
    category: "Mécanique",
    difficulty: 1,
    question: "Voyant rouge moteur s'allume :",
    options: [
      "Continue, ce n'est rien",
      "Arrêter le véhicule rapidement",
      "Accélérer",
      "Vérifier dans 100 km",
    ],
    correctAnswer: 1,
    explanation: "Voyant rouge = danger immédiat, arrêt impératif.",
    tip: "Rouge = stop. Orange = surveillance.",
    commonMistake: "Continuer 'jusqu'au garage'.",
  },

  // PREMIERS SECOURS (6 questions)
  {
    id: 80,
    category: "Premiers Secours",
    difficulty: 1,
    question: "Numéro d'urgence européen ?",
    options: ["15", "17", "18", "112"],
    correctAnswer: 3,
    explanation: "112 = numéro d'urgence unique européen (tous services).",
    tip: "112 fonctionne même sans réseau de votre opérateur.",
    commonMistake: "Oublier le 112 et chercher le bon numéro.",
  },
  {
    id: 81,
    category: "Premiers Secours",
    difficulty: 2,
    question: "Victime inconsciente qui respire :",
    options: [
      "Position Latérale de Sécurité (PLS)",
      "Bouche-à-bouche",
      "Massage cardiaque",
      "La laisser sur le dos",
    ],
    correctAnswer: 0,
    explanation: "Inconscient + respire = PLS pour éviter étouffement.",
    tip: "PLS protège les voies aériennes.",
    commonMistake:
      "Laisser sur le dos = risque d'étouffement par langue ou vomi.",
  },
  {
    id: 82,
    category: "Premiers Secours",
    difficulty: 3,
    question: "Victime saigne abondamment du bras :",
    options: [
      "Garrot immédiat",
      "Compression directe de la plaie",
      "Attendre les secours",
      "Nettoyer d'abord",
    ],
    correctAnswer: 1,
    explanation:
      "Hémorragie : compression directe forte et continue sur la plaie.",
    tip: "Garrot = dernier recours si compression inefficace.",
    commonMistake: "Faire garrot systématiquement = risque amputation.",
  },

  // ÉCO-CONDUITE (8 questions)
  {
    id: 90,
    category: "Éco-conduite",
    difficulty: 2,
    question: "Pour consommer moins de carburant :",
    options: [
      "Accélérations brutales",
      "Conduite souple anticipée",
      "Fenêtres ouvertes sur autoroute",
      "Rouler au point mort",
    ],
    correctAnswer: 1,
    explanation:
      "Conduite souple, anticipation, rapports élevés = -20% consommation.",
    tip: "Anticiper pour éviter freinages/accélérations inutiles.",
    commonMistake: "Penser que vitesse rapide = économie.",
  },
  {
    id: 91,
    category: "Éco-conduite",
    difficulty: 2,
    question: "Climatisation augmente la consommation de :",
    options: ["5%", "10%", "15-25%", "50%"],
    correctAnswer: 2,
    explanation: "Clim = +15 à 25% de consommation en ville.",
    tip: "Préférer aération en ville, clim sur route.",
    commonMistake: "Laisser clim en permanence.",
  },
];

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// CATEGORIES & BADGES CONFIGURATION
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

const CATEGORIES = [
  { id: "Signalisation", name: "Signalisation", icon: "🚦" },
  { id: "Priorités", name: "Priorités", icon: "⚠️" },
  { id: "Vitesse", name: "Vitesse", icon: "🏎️" },
  { id: "Alcool & Drogues", name: "Alcool & Drogues", icon: "🚫" },
  { id: "Sécurité", name: "Sécurité", icon: "🦺" },
  { id: "Conducteur", name: "Conducteur", icon: "👤" },
  { id: "Route", name: "Route", icon: "🛣️" },
  { id: "Mécanique", name: "Mécanique", icon: "🔧" },
  { id: "Premiers Secours", name: "Premiers Secours", icon: "🚑" },
  { id: "Éco-conduite", name: "Éco-conduite", icon: "🌱" },
];

const BADGES = [
  {
    id: "first_step",
    name: "Premier Pas",
    icon: "🎯",
    condition: (q) => q >= 1,
  },
  { id: "streak_5", name: "Série 5", icon: "🔥", condition: (q, s) => s >= 5 },
  {
    id: "streak_10",
    name: "Série 10",
    icon: "⚡",
    condition: (q, s) => s >= 10,
  },
  {
    id: "streak_20",
    name: "Série 20",
    icon: "💥",
    condition: (q, s) => s >= 20,
  },
  { id: "exam_passed", name: "Examen Réussi", icon: "🏆" },
  { id: "perfect_exam", name: "Sans Faute", icon: "💎" },
  { id: "speed_demon", name: "Éclair", icon: "⚡" },
  { id: "level_5", name: "Expert", icon: "🎓", condition: (q, s, l) => l >= 5 },
  {
    id: "level_10",
    name: "Maître",
    icon: "👑",
    condition: (q, s, l) => l >= 10,
  },
];

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// APPLICATION STATE
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

class AppState {
  constructor() {
    this.loadProgress();
  }

  loadProgress() {
    const saved = localStorage.getItem("codeRouteProgress");
    if (saved) {
      Object.assign(this, JSON.parse(saved));
    } else {
      this.level = 1;
      this.xp = 0;
      this.totalQuestions = 0;
      this.correctAnswers = 0;
      this.streak = 0;
      this.maxStreak = 0;
      this.categoryStats = {};
      this.errorHistory = [];
      this.badges = [];
      this.examResults = [];
      this.settings = {
        darkMode: false,
        sounds: true,
        vibrations: true,
      };
    }
  }

  save() {
    localStorage.setItem("codeRouteProgress", JSON.stringify(this));
  }

  addXP(amount) {
    this.xp += amount;
    const oldLevel = this.level;
    this.level = Math.floor(this.xp / 1000) + 1;
    this.save();
    return this.level > oldLevel;
  }

  recordAnswer(questionId, correct, category) {
    this.totalQuestions++;
    if (correct) {
      this.correctAnswers++;
      this.streak++;
      this.maxStreak = Math.max(this.maxStreak, this.streak);
    } else {
      this.streak = 0;
      if (!this.errorHistory.includes(questionId)) {
        this.errorHistory.push(questionId);
      }
    }

    if (!this.categoryStats[category]) {
      this.categoryStats[category] = { total: 0, correct: 0 };
    }
    this.categoryStats[category].total++;
    if (correct) this.categoryStats[category].correct++;

    this.save();
  }

  unlockBadge(badgeId) {
    if (!this.badges.includes(badgeId)) {
      this.badges.push(badgeId);
      this.save();
      return true;
    }
    return false;
  }

  getSuccessRate() {
    return this.totalQuestions > 0
      ? Math.round((this.correctAnswers / this.totalQuestions) * 100)
      : 0;
  }

  getCategoryRate(category) {
    const stats = this.categoryStats[category];
    return stats && stats.total > 0
      ? Math.round((stats.correct / stats.total) * 100)
      : 0;
  }

  reset() {
    localStorage.removeItem("codeRouteProgress");
    window.location.reload();
  }
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// QUIZ ENGINE
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

class QuizEngine {
  constructor(mode, category = null) {
    this.mode = mode;
    this.category = category;
    this.questions = [];
    this.currentIndex = 0;
    this.score = 0;
    this.startTime = Date.now();
    this.hintUsed = false;
    this.generateQuestions();
  }

  generateQuestions() {
    let pool = [...QUESTIONS_DB];

    switch (this.mode) {
      case "exam":
        this.questions = this.shuffle(pool).slice(0, 40);
        break;
      case "training":
        this.questions = this.adaptiveSelection(pool, 20);
        break;
      case "theme":
        pool = pool.filter((q) => q.category === this.category);
        this.questions = this.shuffle(pool).slice(0, 20);
        break;
      case "errors":
        pool = pool.filter((q) => state.errorHistory.includes(q.id));
        this.questions = this.shuffle(pool);
        break;
      case "difficult":
        pool = pool.filter((q) => q.difficulty >= 3);
        this.questions = this.shuffle(pool).slice(0, 20);
        break;
    }
  }

  adaptiveSelection(pool, count) {
    const weakCategories = this.getWeakCategories();
    const selected = [];

    // 60% from weak categories
    const weakPool = pool.filter((q) => weakCategories.includes(q.category));
    selected.push(...this.shuffle(weakPool).slice(0, Math.floor(count * 0.6)));

    // 20% from errors
    const errorPool = pool.filter((q) => state.errorHistory.includes(q.id));
    selected.push(...this.shuffle(errorPool).slice(0, Math.floor(count * 0.2)));

    // 20% random
    const remaining = pool.filter((q) => !selected.includes(q));
    selected.push(...this.shuffle(remaining).slice(0, Math.floor(count * 0.2)));

    return this.shuffle(selected).slice(0, count);
  }

  getWeakCategories() {
    return CATEGORIES.map((cat) => ({
      id: cat.id,
      rate: state.getCategoryRate(cat.id),
    }))
      .sort((a, b) => a.rate - b.rate)
      .slice(0, 3)
      .map((c) => c.id);
  }

  shuffle(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  getCurrentQuestion() {
    return this.questions[this.currentIndex];
  }

  answerQuestion(answerIndex, manualContext = null) {
    const q = this.getCurrentQuestion();
    const isManual = manualContext && manualContext.manual;
    const correct = isManual
      ? manualContext.manualCorrect
      : answerIndex === q.correctAnswer;

    if (correct) this.score++;

    let xpEarned = correct ? 10 : 2;
    if (q.difficulty >= 3) xpEarned *= 1.5;
    if (state.streak > 5) xpEarned *= 2;
    if (this.mode === "difficult") xpEarned *= 2;
    if (this.hintUsed) xpEarned -= 5;

    xpEarned = Math.max(1, Math.floor(xpEarned));

    const leveledUp = state.addXP(xpEarned);
    state.recordAnswer(q.id, correct, q.category);

    this.hintUsed = false;

    return {
      correct,
      xpEarned,
      leveledUp,
      userAnswer: manualContext?.userAnswer || null,
    };
  }

  nextQuestion() {
    this.currentIndex++;
  }

  isFinished() {
    return this.currentIndex >= this.questions.length;
  }

  getResults() {
    const duration = Math.floor((Date.now() - this.startTime) / 1000);
    const passed =
      this.mode === "exam"
        ? this.score >= 35
        : this.score >= this.questions.length * 0.7;

    if (this.mode === "exam") {
      state.examResults.push({
        date: Date.now(),
        score: this.score,
        total: this.questions.length,
        passed,
        duration,
      });
      state.save();
    }

    return {
      score: this.score,
      total: this.questions.length,
      percentage: Math.round((this.score / this.questions.length) * 100),
      duration,
      passed,
    };
  }
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// UI CONTROLLER
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

let state, quiz, timer;
let freeAnswerMode = false;
let speechEnabled = false;

function init() {
  state = new AppState();
  applySettings();
  setupEventListeners();
  updateHomeScreen();

  setTimeout(() => {
    document.getElementById("splash-screen").style.display = "none";
    document.getElementById("app").classList.remove("hidden");
  }, 2000);
}

function setupEventListeners() {
  // Navigation
  document.getElementById("btn-settings").onclick = () =>
    showScreen("screen-settings");
  document.getElementById("btn-exam-mode").onclick = () => startQuiz("exam");
  document.getElementById("btn-training-mode").onclick = () =>
    startQuiz("training");
  document.getElementById("btn-theme-mode").onclick = () =>
    showScreen("screen-themes");
  document.getElementById("btn-errors-mode").onclick = () =>
    startQuiz("errors");
  document.getElementById("btn-difficult-mode").onclick = () =>
    startQuiz("difficult");

  // Back buttons
  document.getElementById("btn-back-themes").onclick = () =>
    showScreen("screen-home");
  document.getElementById("btn-back-stats").onclick = () =>
    showScreen("screen-home");
  document.getElementById("btn-back-settings").onclick = () =>
    showScreen("screen-home");
  document.getElementById("btn-quit-quiz").onclick = quitQuiz;

  // Results
  document.getElementById("btn-home").onclick = () => showScreen("screen-home");
  document.getElementById("btn-view-stats").onclick = () =>
    showScreen("screen-stats");

  // Settings
  document.getElementById("toggle-dark-mode").onchange = toggleDarkMode;
  document.getElementById("toggle-sounds").onchange = (e) => {
    state.settings.sounds = e.target.checked;
    state.save();
  };
  document.getElementById("toggle-vibrations").onchange = (e) => {
    state.settings.vibrations = e.target.checked;
    state.save();
  };
  document.getElementById("btn-reset-progress").onclick = () => {
    showConfirmModal(
      "🗑️ Réinitialiser",
      "Êtes-vous sûr de vouloir réinitialiser toute votre progression ? Cette action est irréversible.",
      () => state.reset(),
    );
  };

  renderThemesList();
}

function showScreen(screenId) {
  document
    .querySelectorAll(".screen")
    .forEach((s) => s.classList.remove("active"));
  document.getElementById(screenId).classList.add("active");

  if (screenId === "screen-home") updateHomeScreen();
  if (screenId === "screen-stats") updateStatsScreen();
}

function updateHomeScreen() {
  document.getElementById("user-level").textContent = state.level;
  document.getElementById("level-number").textContent = state.level;

  const xpForNext = state.level * 1000;
  const currentLevelXP = state.xp % 1000;
  document.getElementById("current-xp").textContent = currentLevelXP;
  document.getElementById("next-level-xp").textContent = 1000;
  document.getElementById("xp-fill").style.width =
    (currentLevelXP / 1000) * 100 + "%";

  document.getElementById("stat-total").textContent = state.totalQuestions;
  document.getElementById("stat-correct").textContent =
    state.getSuccessRate() + "%";
  document.getElementById("stat-badges").textContent = state.badges.length;

  const streakBadge = document.getElementById("streak-badge");
  if (state.streak > 0) {
    streakBadge.classList.remove("hidden");
    document.getElementById("streak-count").textContent = state.streak;
  } else {
    streakBadge.classList.add("hidden");
  }

  const errorsCount = document.getElementById("errors-count");
  errorsCount.textContent =
    state.errorHistory.length > 0
      ? `${state.errorHistory.length} erreur(s) à revoir`
      : "Aucune erreur enregistrée";
}

function renderThemesList() {
  const container = document.getElementById("themes-list");
  container.innerHTML = CATEGORIES.map((cat) => {
    const stats = state.categoryStats[cat.id];
    const rate = state.getCategoryRate(cat.id);
    const total = stats ? stats.total : 0;

    return `
            <button class="theme-card" onclick="startQuiz('theme', '${cat.id}')">
                <div class="theme-info">
                    <div class="theme-name">${cat.icon} ${cat.name}</div>
                    <div class="theme-stats">${total} question(s) - ${rate}% réussite</div>
                </div>
                <div class="theme-progress">
                    <svg width="60" height="60">
                        <circle cx="30" cy="30" r="25" fill="none" stroke="var(--bg-secondary)" stroke-width="4"></circle>
                        <circle cx="30" cy="30" r="25" fill="none" stroke="var(--primary)" stroke-width="4"
                            stroke-dasharray="157" stroke-dashoffset="${157 - (157 * rate) / 100}"
                            transform="rotate(-90 30 30)" stroke-linecap="round"></circle>
                    </svg>
                    <div class="theme-progress-text">${rate}%</div>
                </div>
            </button>
        `;
  }).join("");
}

function startQuiz(mode, category = null) {
  if (mode === "errors" && state.errorHistory.length === 0) {
    showToast("Aucune erreur à réviser !", "info");
    return;
  }

  quiz = new QuizEngine(mode, category);
  showScreen("screen-quiz");

  if (mode === "exam") {
    startTimer();
    document.getElementById("quiz-timer").classList.remove("hidden");
  } else {
    document.getElementById("quiz-timer").classList.add("hidden");
  }

  displayQuestion();
}

function displayQuestion() {
  const q = quiz.getCurrentQuestion();

  document.getElementById("question-counter").textContent =
    `${quiz.currentIndex + 1}/${quiz.questions.length}`;
  document.getElementById("progress-fill").style.width =
    (quiz.currentIndex / quiz.questions.length) * 100 + "%";

  document.getElementById("question-category").textContent =
    CATEGORIES.find((c) => c.id === q.category)?.icon + " " + q.category;
  document.getElementById("question-text").textContent = q.question;

  const imgContainer = document.getElementById("question-image-container");
  if (q.image) {
    document.getElementById("question-image").src = q.image;
    imgContainer.classList.remove("hidden");
  } else {
    imgContainer.classList.add("hidden");
  }

  const optionsContainer = document.getElementById("options-container");
  optionsContainer.innerHTML = q.options
    .map(
      (opt, i) => `
        <button class="option-btn" onclick="selectAnswer(${i})">
            <div class="option-letter">${String.fromCharCode(65 + i)}</div>
            <div class="option-text">${opt}</div>
        </button>
    `,
    )
    .join("");

  freeAnswerMode = false;
  const freeContainer = document.getElementById("free-answer-container");
  freeContainer.classList.add("hidden");
  const freeInput = document.getElementById("free-answer-input");
  freeInput.value = "";
  const toggleButton = document.getElementById("btn-toggle-answer-mode");
  toggleButton.setAttribute("aria-pressed", "false");
  toggleButton.classList.remove("active");
  toggleButton.onclick = toggleAnswerMode;
  document.getElementById("btn-submit-free-answer").onclick = submitFreeAnswer;
  const readerButton = document.getElementById("btn-a11y-reader");
  readerButton.setAttribute("aria-pressed", speechEnabled ? "true" : "false");
  readerButton.classList.toggle("active", speechEnabled);
  readerButton.onclick = toggleReaderMode;

  if (speechEnabled) speakQuestion(q);

  document.getElementById("hint-text").classList.add("hidden");
  document.getElementById("btn-hint").classList.remove("used");
  document.getElementById("btn-hint").onclick = showHint;
  document.getElementById("answer-feedback").classList.add("hidden");
}

function showHint() {
  const q = quiz.getCurrentQuestion();
  document.getElementById("hint-text").textContent = q.tip;
  document.getElementById("hint-text").classList.remove("hidden");
  document.getElementById("btn-hint").classList.add("used");
  quiz.hintUsed = true;
  vibrate();
}

function selectAnswer(index) {
  if (freeAnswerMode) return;

  const q = quiz.getCurrentQuestion();
  const result = quiz.answerQuestion(index);

  const buttons = document.querySelectorAll(".option-btn");
  buttons.forEach((btn, i) => {
    btn.classList.add("disabled");
    if (i === q.correctAnswer) btn.classList.add("correct");
    if (i === index && !result.correct) btn.classList.add("incorrect");
  });

  playSound(result.correct ? "success" : "error");
  vibrate();

  setTimeout(() => showFeedback(result), 500);
}

function showFeedback(result) {
  const q = quiz.getCurrentQuestion();

  document.getElementById("feedback-icon").textContent = result.correct
    ? "🎉"
    : "😔";
  document.getElementById("feedback-title").textContent = result.correct
    ? "Bonne réponse !"
    : "Mauvaise réponse";
  document.getElementById("feedback-title").className =
    "feedback-title " + (result.correct ? "correct" : "incorrect");
  document.getElementById("feedback-message").textContent = result.correct
    ? "Continuez comme ça !"
    : "Ne vous découragez pas, chaque erreur est une leçon.";

  const userAnswerEl = document.getElementById("feedback-user-answer");
  if (result.userAnswer) {
    userAnswerEl.textContent = `Votre réponse : ${result.userAnswer}`;
    userAnswerEl.classList.remove("hidden");
  } else {
    userAnswerEl.classList.add("hidden");
  }

  if (speechEnabled && window.speechSynthesis) {
    const message = result.correct
      ? "Bonne réponse. Continuez !"
      : `Mauvaise réponse. La bonne réponse était ${q.options[q.correctAnswer]}`;
    speakText(message);
  }

  document.getElementById("explanation-text").textContent = q.explanation;
  document.getElementById("tip-text").textContent = q.tip;
  document.getElementById("mistake-text").textContent = q.commonMistake;
  document.getElementById("xp-earned").textContent = `+${result.xpEarned} XP`;

  document.getElementById("answer-feedback").classList.remove("hidden");
  document.getElementById("btn-next-question").onclick = nextQuestion;

  if (result.leveledUp) {
    showToast(`🎉 Niveau ${state.level} atteint !`, "success");
  }
}

function nextQuestion() {
  quiz.nextQuestion();

  if (quiz.isFinished()) {
    showResults();
  } else {
    displayQuestion();
  }
}

function showResults() {
  if (timer) clearInterval(timer);

  const results = quiz.getResults();
  showScreen("screen-results");

  document.getElementById("results-icon").textContent = results.passed
    ? "🎉"
    : "😔";
  document.getElementById("results-title").textContent = results.passed
    ? "Félicitations !"
    : "Pas encore...";
  document.getElementById("results-subtitle").textContent = results.passed
    ? "Vous avez réussi !"
    : "Continuez à vous entraîner";

  document.getElementById("results-score").textContent =
    `${results.score}/${results.total}`;
  document.querySelector(".score-label").textContent = results.passed
    ? "Réussi"
    : "Échoué";

  const minutes = Math.floor(results.duration / 60);
  const seconds = results.duration % 60;
  document.getElementById("result-time").textContent =
    `${minutes}:${seconds.toString().padStart(2, "0")}`;
  document.getElementById("result-accuracy").textContent =
    results.percentage + "%";
  document.getElementById("result-xp").textContent =
    `+${Math.floor(results.score * 10)} XP`;

  // Animate score ring
  const circumference = 2 * Math.PI * 85;
  const offset = circumference - (results.percentage / 100) * circumference;
  document.getElementById("score-ring-progress").style.strokeDashoffset =
    offset;

  // Check badges
  checkBadges(results);
}

function checkBadges(results) {
  const newBadges = [];

  if (state.totalQuestions === 1) newBadges.push("first_step");
  if (state.streak >= 5) newBadges.push("streak_5");
  if (state.streak >= 10) newBadges.push("streak_10");
  if (state.streak >= 20) newBadges.push("streak_20");
  if (results.passed && quiz.mode === "exam") newBadges.push("exam_passed");
  if (results.score === results.total && quiz.mode === "exam")
    newBadges.push("perfect_exam");
  if (results.duration < 900 && quiz.mode === "exam")
    newBadges.push("speed_demon");
  if (state.level >= 5) newBadges.push("level_5");
  if (state.level >= 10) newBadges.push("level_10");

  const unlocked = newBadges.filter((id) => state.unlockBadge(id));

  if (unlocked.length > 0) {
    const badgesList = unlocked
      .map((id) => {
        const badge = BADGES.find((b) => b.id === id);
        return `<div class="badge-item">${badge.icon}</div>`;
      })
      .join("");

    document.getElementById("badges-list").innerHTML = badgesList;
    document.getElementById("new-badges").classList.remove("hidden");
  }
}

function updateStatsScreen() {
  document.getElementById("total-questions-stat").textContent =
    state.totalQuestions;
  document.getElementById("success-rate-stat").textContent =
    state.getSuccessRate() + "%";

  const categoryList = document.getElementById("category-stats-list");
  categoryList.innerHTML = CATEGORIES.map((cat) => {
    const rate = state.getCategoryRate(cat.id);
    const stats = state.categoryStats[cat.id] || { total: 0 };

    return `
            <div class="category-stat-item">
                <div class="category-stat-header">
                    <span class="category-stat-name">${cat.icon} ${cat.name}</span>
                    <span class="category-stat-score">${rate}%</span>
                </div>
                <div class="category-stat-bar">
                    <div class="category-stat-fill" style="width: ${rate}%"></div>
                </div>
            </div>
        `;
  }).join("");

  const badgesGrid = document.getElementById("all-badges-list");
  badgesGrid.innerHTML = BADGES.map((badge) => {
    const unlocked = state.badges.includes(badge.id);
    return `
            <div class="badge-card ${unlocked ? "unlocked" : "locked"}">
                <div class="badge-icon">${badge.icon}</div>
                <div class="badge-name">${badge.name}</div>
            </div>
        `;
  }).join("");

  const examList = document.getElementById("exam-history-list");
  if (state.examResults.length === 0) {
    examList.innerHTML =
      '<p style="text-align:center;color:var(--text-secondary)">Aucun examen passé</p>';
  } else {
    examList.innerHTML = state.examResults
      .slice(-5)
      .reverse()
      .map((exam) => {
        const date = new Date(exam.date).toLocaleDateString("fr-FR");
        return `
                <div class="exam-history-item">
                    <div>
                        <div class="exam-date">${date}</div>
                        <div class="exam-result ${exam.passed ? "passed" : "failed"}">
                            ${exam.score}/${exam.total} - ${exam.passed ? "Réussi" : "Échoué"}
                        </div>
                    </div>
                </div>
            `;
      })
      .join("");
  }
}

function quitQuiz() {
  showConfirmModal(
    "⚠️ Quitter le quiz",
    "Voulez-vous vraiment quitter ? Votre progression ne sera pas sauvegardée.",
    () => {
      if (timer) clearInterval(timer);
      if (window.speechSynthesis) window.speechSynthesis.cancel();
      showScreen("screen-home");
    },
  );
}

function showConfirmModal(title, message, onConfirm) {
  const modal = document.getElementById("confirm-modal");
  modal.querySelector(".modal-title").textContent = title;
  modal.querySelector(".modal-message").textContent = message;

  modal.classList.remove("hidden");

  document.getElementById("modal-confirm").onclick = () => {
    modal.classList.add("hidden");
    onConfirm();
  };

  document.getElementById("modal-cancel").onclick = () => {
    modal.classList.add("hidden");
  };

  // Close on backdrop click
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
    }
  };
}

function startTimer() {
  let seconds = 1800; // 30 minutes
  timer = setInterval(() => {
    seconds--;
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById("quiz-timer").textContent =
      `⏱️ ${mins}:${secs.toString().padStart(2, "0")}`;

    if (seconds <= 0) {
      clearInterval(timer);
      showResults();
    }
  }, 1000);
}

function toggleDarkMode(e) {
  state.settings.darkMode = e.target.checked;
  state.save();
  applySettings();
}

function toggleAnswerMode() {
  freeAnswerMode = !freeAnswerMode;
  const optionsContainer = document.getElementById("options-container");
  const freeContainer = document.getElementById("free-answer-container");
  const toggleButton = document.getElementById("btn-toggle-answer-mode");

  toggleButton.setAttribute("aria-pressed", freeAnswerMode ? "true" : "false");
  toggleButton.classList.toggle("active", freeAnswerMode);

  if (freeAnswerMode) {
    optionsContainer.classList.add("collapsed");
    freeContainer.classList.remove("hidden");
    document.getElementById("free-answer-input").focus();
  } else {
    optionsContainer.classList.remove("collapsed");
    freeContainer.classList.add("hidden");
  }
}

function toggleReaderMode() {
  speechEnabled = !speechEnabled;
  const readerButton = document.getElementById("btn-a11y-reader");
  readerButton.setAttribute("aria-pressed", speechEnabled ? "true" : "false");
  readerButton.classList.toggle("active", speechEnabled);

  if (speechEnabled) {
    const q = quiz.getCurrentQuestion();
    speakQuestion(q);
  } else if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
  }
}

function speakQuestion(question) {
  if (!window.speechSynthesis) {
    showToast(
      "La lecture audio n'est pas disponible sur cet appareil.",
      "warning",
    );
    speechEnabled = false;
    const readerButton = document.getElementById("btn-a11y-reader");
    readerButton.setAttribute("aria-pressed", "false");
    readerButton.classList.remove("active");
    return;
  }

  window.speechSynthesis.cancel();

  const toSpeak = [];
  toSpeak.push(`Question : ${question.question}`);
  question.options.forEach((opt, idx) => {
    toSpeak.push(`Réponse ${String.fromCharCode(65 + idx)} : ${opt}`);
  });

  const utterance = new SpeechSynthesisUtterance(toSpeak.join(". "));
  utterance.lang = "fr-FR";
  utterance.rate = 1;
  utterance.pitch = 1;
  window.speechSynthesis.speak(utterance);
}

function submitFreeAnswer() {
  if (!freeAnswerMode) {
    showToast("Activez d'abord le mode réponse libre.", "info");
    return;
  }

  const textarea = document.getElementById("free-answer-input");
  const answer = textarea.value.trim();

  if (!answer) {
    showToast("Veuillez saisir une réponse avant de valider.", "warning");
    textarea.focus();
    return;
  }

  if (speechEnabled && window.speechSynthesis) {
    window.speechSynthesis.cancel();
  }

  const q = quiz.getCurrentQuestion();
  const normalized = (text) =>
    text
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9 ]/g, " ")
      .replace(/\s+/g, " ")
      .trim();

  const correctText = normalized(q.options[q.correctAnswer]);
  const userText = normalized(answer);

  const threshold = 0.75;

  const isCorrect =
    userText &&
    (userText === correctText ||
      correctText.includes(userText) ||
      computeSimilarity(userText, correctText) >= threshold);

  const result = quiz.answerQuestion(q.correctAnswer, {
    manual: true,
    manualCorrect: isCorrect,
    userAnswer: answer,
  });

  const buttons = document.querySelectorAll(".option-btn");
  buttons.forEach((btn, i) => {
    btn.classList.add("disabled");
    if (i === q.correctAnswer) btn.classList.add("correct");
    if (!isCorrect && i === q.correctAnswer) btn.classList.add("highlight");
  });

  playSound(result.correct ? "success" : "error");
  vibrate();

  setTimeout(() => showFeedback(result), 500);
}

function applySettings() {
  document.documentElement.setAttribute(
    "data-theme",
    state.settings.darkMode ? "dark" : "light",
  );
  document.getElementById("toggle-dark-mode").checked = state.settings.darkMode;
  document.getElementById("toggle-sounds").checked = state.settings.sounds;
  document.getElementById("toggle-vibrations").checked =
    state.settings.vibrations;
}

function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.getElementById("toast-container").appendChild(toast);

  setTimeout(() => toast.remove(), 3000);
}

function playSound(type) {
  if (!state.settings.sounds) return;
  // Would play sound in production
}

function vibrate() {
  if (!state.settings.vibrations) return;
  if (navigator.vibrate) navigator.vibrate(50);
}

function computeSimilarity(a, b) {
  const distance = levenshteinDistance(a, b);
  const maxLen = Math.max(a.length, b.length) || 1;
  return 1 - distance / maxLen;
}

function levenshteinDistance(a, b) {
  const matrix = Array.from({ length: a.length + 1 }, () =>
    Array(b.length + 1).fill(0),
  );

  for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
  for (let j = 0; j <= b.length; j++) matrix[0][j] = j;

  for (let i = 1; i <= a.length; i++) {
    for (let j = 1; j <= b.length; j++) {
      const cost = a[i - 1] === b[j - 1] ? 0 : 1;
      matrix[i][j] = Math.min(
        matrix[i - 1][j] + 1,
        matrix[i][j - 1] + 1,
        matrix[i - 1][j - 1] + cost,
      );
    }
  }

  return matrix[a.length][b.length];
}

function speakText(text) {
  if (!speechEnabled || !window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "fr-FR";
  utterance.rate = 1;
  utterance.pitch = 1;
  window.speechSynthesis.speak(utterance);
}

// Initialize app
document.addEventListener("DOMContentLoaded", init);
